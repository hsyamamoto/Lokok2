name: Backup Railway Production

on:
  workflow_dispatch:
    inputs:
      production_url:
        description: "Production URL (default: https://new-lokok-production.up.railway.app)"
        required: false
        default: "https://new-lokok-production.up.railway.app"
      include_logs:
        description: "Include last 1000 lines of logs (default: false)"
        required: false
        default: "true"
  schedule:
    - cron: '0 2 * * *'

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true
          clean: true
          lfs: true
          submodules: false

      - name: Mark workspace as safe directory (fix git 128)
        if: always()
        continue-on-error: true
        run: |
          git --version
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global --add safe.directory "/github/workspace"
          repo_name="${{ github.repository }}"
          base_name=$(basename "$GITHUB_WORKSPACE")
          git config --global --add safe.directory "/home/runner/work/${repo_name}/${base_name}"
          git config --global --add safe.directory "$(pwd)"
          git config --global --list | sed -n 's/^safe\.directory=\(.*\)$/safe.directory=\1/p'
          git status || true

      - name: Neutralize broken submodule config (prevent git 128 in post-job)
        if: always()
        continue-on-error: true
        run: |
          if [ -f .gitmodules ]; then
            echo "Found .gitmodules; printing contents:"
            cat .gitmodules || true
          fi
          # Remove tracked .gitmodules if present
          if git ls-files --error-unmatch .gitmodules >/dev/null 2>&1; then
            git rm -f --cached .gitmodules || true
          fi
          # Remove any .gitmodules files and purge ALL local submodule config
          find . -name .gitmodules -type f -print -exec rm -f {} \; || true
          sections=$(git config --local --name-only --get-regexp '^submodule\.' | sed -E 's/^(submodule\.[^\.]+).*$/\1/' | sort -u || true)
          for s in $sections; do
            git config --local --remove-section "$s" || true
          done
          # Best-effort deinit
          git submodule deinit -f --all || true
          git config --local --list | sed -n 's/^submodule\..*/&/p' || true
          git status || true

      - name: Inject Railway token env for subsequent steps
        run: |
          if [ -n "${{ secrets.RAILWAY_TOKEN }}" ]; then
            echo "RAILWAY_TOKEN=${{ secrets.RAILWAY_TOKEN }}" >> $GITHUB_ENV
          fi
          if [ -n "${{ secrets.RAILWAY_API_TOKEN }}" ]; then
            echo "RAILWAY_API_TOKEN=${{ secrets.RAILWAY_API_TOKEN }}" >> $GITHUB_ENV
          fi

      - name: Validate Railway token secrets
        run: |
          if [ -z "$RAILWAY_TOKEN" ] && [ -z "$RAILWAY_API_TOKEN" ]; then
            echo "ERROR: Defina RAILWAY_TOKEN (projeto) ou RAILWAY_API_TOKEN (conta/time) em GitHub Secrets."
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Prepare Railway auth (no interactive login)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: |
          set -e
          TOKEN_SOURCE=""
          TOKEN="$RAILWAY_TOKEN"
          if [ -n "$RAILWAY_TOKEN" ]; then
            TOKEN_SOURCE="project"
          fi
          if [ -z "$TOKEN" ] && [ -n "$RAILWAY_API_TOKEN" ]; then
            TOKEN="$RAILWAY_API_TOKEN"
            TOKEN_SOURCE="account"
          fi
          if [ -z "$TOKEN" ]; then
            echo "ERROR: Nenhum token Railway fornecido (RAILWAY_TOKEN/RAILWAY_API_TOKEN)." >&2
            exit 1
          fi
          echo "Usando token Railway via variÃ¡vel de ambiente (tipo: $TOKEN_SOURCE)."
          echo "RAILWAY_TOKEN=$TOKEN" >> $GITHUB_ENV
          railway --version || true

      - name: Collect Railway environment and production info
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          PROD_URL: ${{ inputs.production_url }}
          INCLUDE_LOGS: ${{ inputs.include_logs }}
        run: |
          set -e
          set -o pipefail
          # Ensure Railway CLI is available
          if ! command -v railway >/dev/null 2>&1; then
            echo "Railway CLI missing; installing..."
            npm install -g @railway/cli
          fi
          mkdir -p backup
          echo "== Railway CLI ==" > backup/cli_version.txt
          railway --version >> backup/cli_version.txt || true

          echo "Collecting Railway status..."
          railway status --project "$RAILWAY_PROJECT_ID" > backup/status.txt || true

          echo "Collecting Railway variables (text)..."
          railway variables --project "$RAILWAY_PROJECT_ID" > backup/env.txt || true

          echo "Collecting Railway variables (json)..."
          railway variables --project "$RAILWAY_PROJECT_ID" --json > backup/env.json 2>/dev/null || echo '{}' > backup/env.json

          echo "Listing Railway services..."
          railway service list --project "$RAILWAY_PROJECT_ID" > backup/services.txt 2>/dev/null || true

          echo "Listing Railway domains..."
          railway domain list --project "$RAILWAY_PROJECT_ID" > backup/domains.txt 2>/dev/null || true

          echo "Project info..."
          railway project --project "$RAILWAY_PROJECT_ID" > backup/project.txt 2>/dev/null || true

          if [ -n "$PROD_URL" ]; then
            echo "Fetching production health: $PROD_URL/health"
            curl -s "$PROD_URL/health" > backup/health.txt || true
            echo "Fetching session debug: $PROD_URL/session-debug"
            curl -s "$PROD_URL/session-debug" > backup/session-debug.txt || true
            echo "Fetching root HTML: $PROD_URL/"
            curl -s "$PROD_URL/" > backup/root.html || true
          fi

          if [ "$INCLUDE_LOGS" = "true" ]; then
            echo "Collecting last 1000 lines of logs..."
            railway logs --lines 1000 --project "$RAILWAY_PROJECT_ID" > backup/logs.txt 2>/dev/null || true
          fi

      - name: Dump PostgreSQL database (if DATABASE_URL is set)
        run: |
          set -e
          set -o pipefail
          sudo apt-get update
          sudo apt-get install -y postgresql-client jq
          DB_URL=$(jq -r '."DATABASE_URL" // empty' backup/env.json || echo "")
          if [ -n "$DB_URL" ]; then
            echo "Dumping PostgreSQL database..."
            pg_dump "$DB_URL" -f backup/db.sql || echo "Plain SQL dump failed"
            pg_dump "$DB_URL" -Fc -f backup/db.dump || echo "Custom dump failed"
          else
            echo "DATABASE_URL not found in backup/env.json; skipping DB dump."
          fi

      - name: Upload backup artifact
        uses: actions/upload-artifact@v4
        with:
          name: railway-production-backup-${{ github.run_id }}
          retention-days: 30
          path: |
            backup
            railway.json
            .github/workflows/deploy-railway.yml
            .github/workflows/set-railway-variables.yml
