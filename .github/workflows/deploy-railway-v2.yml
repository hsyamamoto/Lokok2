name: Deploy to Railway v2

on:
  workflow_dispatch:
    inputs:
      PUBLIC_URL:
        description: 'Public URL to verify after deploy (optional)'
        required: false
        default: ''

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          clean: true

      - name: Repo diagnostics (root, files, label check)
        run: |
          set -e
          echo "Repo root contents:"
          ls -la
          echo "Git HEAD: $(git rev-parse HEAD)"
          echo "Last commit:"
          git log -1 --pretty=format:'%h %ad %an %s' --date=iso
          echo "Searching for Countries label in views/dashboard.ejs (root)"
          if [ -f "views/dashboard.ejs" ]; then
            grep -n "Countries:" views/dashboard.ejs || (echo "ERROR: Countries label not found in root views/dashboard.ejs" >&2; exit 1)
          else
            echo "WARNING: Root views/dashboard.ejs not found; project may use subdirectory."
          fi
          echo "Server candidates present:"
          for f in server.js Lokok2/server.js Lokok2/Lokok2/server.js Lokok2/Lokok2/Lokok2/server.js; do
            if [ -f "$f" ]; then
              echo "- $f (size $(wc -c < "$f") bytes)"
              echo "  version route lines:"; grep -n "app.get('/version'" "$f" || true
            fi
          done

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Railway CLI
        run: |
          npm i -g @railway/cli
          railway --version

      - name: Prepare Railway token env (v4, no login)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: |
          set -e
          TOKEN_SOURCE=""
          TOKEN="$RAILWAY_TOKEN"
          if [ -n "$RAILWAY_TOKEN" ]; then
            TOKEN_SOURCE="project"
          fi
          if [ -z "$TOKEN" ] && [ -n "$RAILWAY_API_TOKEN" ]; then
            TOKEN="$RAILWAY_API_TOKEN"
            TOKEN_SOURCE="account"
          fi
          if [ -z "$TOKEN" ]; then
            echo "ERROR: Provide RAILWAY_TOKEN or RAILWAY_API_TOKEN as a secret." >&2
            exit 1
          fi
          echo "Setting token env for Railway CLI (fingerprint: v2-2025-12-05)"
          echo "RAILWAY_TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "RAILWAY_TOKEN_SOURCE=$TOKEN_SOURCE" >> $GITHUB_ENV

      - name: Diagnostics (whoami, status)
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          set -e
          echo "Token present: $([ -n \"$RAILWAY_TOKEN\" ] && echo yes || echo no)"
          if [ "$RAILWAY_TOKEN_SOURCE" = "account" ]; then
            echo "Attempting whoami with account token"
            set +e
            railway whoami
            WHOAMI_EXIT=$?
            set -e
            if [ $WHOAMI_EXIT -ne 0 ]; then
              echo "Skipping whoami: not permitted or unauthorized with current account token type"
            fi
          else
            echo "Skipping whoami: project tokens do not support whoami"
          fi
          if [ -z "$RAILWAY_PROJECT_ID" ]; then
            echo "ERROR: RAILWAY_PROJECT_ID secret is required for v2 workflow." >&2
            exit 1
          fi
          if [ "$RAILWAY_TOKEN_SOURCE" = "account" ]; then
            echo "Checking project status with account token"
            set +e
            railway status --project "$RAILWAY_PROJECT_ID"
            STATUS_EXIT=$?
            set -e
            if [ $STATUS_EXIT -ne 0 ]; then
              echo "Skipping status: unauthorized with current token type; continuing to deploy"
            fi
          else
            echo "Skipping status: project tokens may not permit status; continuing"
          fi

      # Removed: Excel download — app now reads from Google Drive only

      - name: Resolve PUBLIC_URL param
        env:
          PUBLIC_URL_INPUT: ${{ github.event.inputs.PUBLIC_URL }}
          PUBLIC_URL_VAR: ${{ vars.PUBLIC_URL }}
          PUBLIC_URL_SECRET: ${{ secrets.PUBLIC_URL }}
        run: |
          set -e
          PUBLIC_URL_FINAL="$PUBLIC_URL_INPUT"
          if [ -z "$PUBLIC_URL_FINAL" ] && [ -n "$PUBLIC_URL_VAR" ]; then
            PUBLIC_URL_FINAL="$PUBLIC_URL_VAR"
          fi
          if [ -z "$PUBLIC_URL_FINAL" ] && [ -n "$PUBLIC_URL_SECRET" ]; then
            PUBLIC_URL_FINAL="$PUBLIC_URL_SECRET"
          fi
          echo "Resolved PUBLIC_URL: '${PUBLIC_URL_FINAL}'"
          echo "PUBLIC_URL_FINAL=${PUBLIC_URL_FINAL}" >> $GITHUB_ENV

      - name: Deploy (project targeted, no link)
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
          RAILWAY_SERVICE_NAME: ${{ secrets.RAILWAY_SERVICE_NAME }}
        run: |
          set -e
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "ERROR: Missing RAILWAY_TOKEN in environment. Configure RAILWAY_TOKEN or RAILWAY_API_TOKEN secret." >&2
            exit 1
          fi
          # Selecionar serviço quando houver múltiplos
          if [ -n "$RAILWAY_SERVICE_ID" ]; then
            SERVICE_FLAG=(--service "$RAILWAY_SERVICE_ID")
            echo "Selecionando serviço por ID: $RAILWAY_SERVICE_ID"
          elif [ -n "$RAILWAY_SERVICE_NAME" ]; then
            SERVICE_FLAG=(--service "$RAILWAY_SERVICE_NAME")
            echo "Selecionando serviço por nome: $RAILWAY_SERVICE_NAME"
          else
            echo "ERROR: Múltiplos serviços encontrados. Defina um secret 'RAILWAY_SERVICE_ID' ou 'RAILWAY_SERVICE_NAME' no repositório para selecionar o serviço." >&2
            echo "Dica: no Railway, abra o projeto, clique no serviço e copie o ID ou o nome." >&2
            exit 1
          fi

          if [ "$RAILWAY_TOKEN_SOURCE" = "project" ]; then
            echo "Usando token de projeto; executando 'railway up --detach --service <...>'"
            railway up --detach "${SERVICE_FLAG[@]}"
          else
            echo "Usando token de conta; tentando 'railway up --detach --service <...>'"
            set +e
            railway up --detach "${SERVICE_FLAG[@]}"
            UP_EXIT=$?
            set -e
            if [ $UP_EXIT -ne 0 ]; then
              echo "Deploy falhou com token de conta. Recomende usar Token de Projeto (RAILWAY_TOKEN)." >&2
              exit $UP_EXIT
            fi
          fi
          echo "Deploy completed (fingerprint: v2-2025-12-05)."

      - name: Post-deploy logs (best-effort)
        if: ${{ always() }}
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
          RAILWAY_SERVICE_NAME: ${{ secrets.RAILWAY_SERVICE_NAME }}
        run: |
          set -e
          echo "Attempting to fetch recent logs (may require account token)"
          if [ -n "$RAILWAY_SERVICE_ID" ]; then
            set +e
            railway logs --service "$RAILWAY_SERVICE_ID" --since 15m --limit 200 | tail -n 200 || echo "Skipping logs: unauthorized or not supported by token"
            set -e
          elif [ -n "$RAILWAY_SERVICE_NAME" ]; then
            set +e
            railway logs --service "$RAILWAY_SERVICE_NAME" --since 15m --limit 200 | tail -n 200 || echo "Skipping logs: unauthorized or not supported by token"
            set -e
          else
            echo "No service selector provided; cannot fetch logs"
          fi

      - name: Verify public URL (/version)
        run: |
          set -e
          if [ -z "${PUBLIC_URL_FINAL}" ]; then
            echo "No PUBLIC_URL provided via input, vars.PUBLIC_URL or secrets.PUBLIC_URL; skipping verification"
            exit 0
          fi
          echo "Verifying PUBLIC_URL: ${PUBLIC_URL_FINAL}/version"
          set +e
          HTTP_CODE=$(curl -s -o resp.txt -w "%{http_code}" "${PUBLIC_URL_FINAL}/version")
          set -e
          echo "HTTP $HTTP_CODE"
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Response:"; sed -n '1,200p' resp.txt || true
            echo "ERROR: /version returned non-200. Check service root directory and start command." >&2
            exit 1
          fi
          echo "Response:"; sed -n '1,200p' resp.txt

      - name: Summary
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          echo "Workflow: Deploy to Railway v2"
          echo "Fingerprint: v2-2025-12-05"
          echo "Project: $RAILWAY_PROJECT_ID"
          echo "Service selector: ID=$RAILWAY_SERVICE_ID NAME=$RAILWAY_SERVICE_NAME"
          echo "Public URL (final): ${PUBLIC_URL_FINAL}"
