name: Deploy to Railway v2

on:
  workflow_dispatch:
    inputs:
      EXCEL_PATH:
        description: 'Excel path or public XLSX URL (optional)'
        required: false
        default: ''

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          clean: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Railway CLI
        run: |
          npm i -g @railway/cli
          railway --version

      - name: Prepare Railway token env (v4, no login)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: |
          set -e
          TOKEN_SOURCE=""
          TOKEN="$RAILWAY_TOKEN"
          if [ -n "$RAILWAY_TOKEN" ]; then
            TOKEN_SOURCE="project"
          fi
          if [ -z "$TOKEN" ] && [ -n "$RAILWAY_API_TOKEN" ]; then
            TOKEN="$RAILWAY_API_TOKEN"
            TOKEN_SOURCE="account"
          fi
          if [ -z "$TOKEN" ]; then
            echo "ERROR: Provide RAILWAY_TOKEN or RAILWAY_API_TOKEN as a secret." >&2
            exit 1
          fi
          echo "Setting token env for Railway CLI (fingerprint: v2-2025-12-05)"
          echo "RAILWAY_TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "RAILWAY_TOKEN_SOURCE=$TOKEN_SOURCE" >> $GITHUB_ENV

      - name: Diagnostics (whoami, status)
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          set -e
          echo "Token present: $([ -n \"$RAILWAY_TOKEN\" ] && echo yes || echo no)"
          if [ "$RAILWAY_TOKEN_SOURCE" = "account" ]; then
            echo "Attempting whoami with account token"
            set +e
            railway whoami
            WHOAMI_EXIT=$?
            set -e
            if [ $WHOAMI_EXIT -ne 0 ]; then
              echo "Skipping whoami: not permitted or unauthorized with current account token type"
            fi
          else
            echo "Skipping whoami: project tokens do not support whoami"
          fi
          if [ -z "$RAILWAY_PROJECT_ID" ]; then
            echo "ERROR: RAILWAY_PROJECT_ID secret is required for v2 workflow." >&2
            exit 1
          fi
          if [ "$RAILWAY_TOKEN_SOURCE" = "account" ]; then
            echo "Checking project status with account token"
            set +e
            railway status --project "$RAILWAY_PROJECT_ID"
            STATUS_EXIT=$?
            set -e
            if [ $STATUS_EXIT -ne 0 ]; then
              echo "Skipping status: unauthorized with current token type; continuing to deploy"
            fi
          else
            echo "Skipping status: project tokens may not permit status; continuing"
          fi

      - name: Optional Excel download
        env:
          EXCEL_PATH_INPUT: ${{ github.event.inputs.EXCEL_PATH }}
        run: |
          set -e
          mkdir -p data
          if [ -n "$EXCEL_PATH_INPUT" ] && echo "$EXCEL_PATH_INPUT" | grep -qiE '^https?://'; then
            echo "Downloading Excel from EXCEL_PATH_INPUT to data/cached_spreadsheet.xlsx"
            curl -L "$EXCEL_PATH_INPUT" -o data/cached_spreadsheet.xlsx
          else
            echo "No EXCEL_PATH URL provided; skipping download"
          fi

      - name: Deploy (project targeted, no link)
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          set -e
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "ERROR: Missing RAILWAY_TOKEN in environment. Configure RAILWAY_TOKEN or RAILWAY_API_TOKEN secret." >&2
            exit 1
          fi
          railway up --detach --project "$RAILWAY_PROJECT_ID"
          echo "Deploy completed (fingerprint: v2-2025-12-05)."

      - name: Summary
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          echo "Workflow: Deploy to Railway v2"
          echo "Fingerprint: v2-2025-12-05"
          echo "Project: $RAILWAY_PROJECT_ID"
