name: Deploy to Railway v2

on:
  workflow_dispatch:
    inputs:
      EXCEL_PATH:
        description: 'Excel path or public XLSX URL (optional)'
        required: false
        default: ''

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          clean: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Railway CLI
        run: |
          npm i -g @railway/cli
          railway --version

      - name: Authenticate Railway CLI with token (no link)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: |
          set -e
          TOKEN="$RAILWAY_TOKEN"
          if [ -z "$TOKEN" ] && [ -n "$RAILWAY_API_TOKEN" ]; then
            TOKEN="$RAILWAY_API_TOKEN"
          fi
          if [ -z "$TOKEN" ]; then
            echo "ERROR: Provide RAILWAY_TOKEN or RAILWAY_API_TOKEN as a secret." >&2
            exit 1
          fi
          echo "Authenticating Railway CLI with token (fingerprint: v2-2025-12-05)"
          railway login --token "$TOKEN"

      - name: Diagnostics (whoami, status)
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          set -e
          railway whoami
          if [ -z "$RAILWAY_PROJECT_ID" ]; then
            echo "ERROR: RAILWAY_PROJECT_ID secret is required for v2 workflow." >&2
            exit 1
          fi
          railway status --project "$RAILWAY_PROJECT_ID"

      - name: Optional Excel download
        env:
          EXCEL_PATH_INPUT: ${{ github.event.inputs.EXCEL_PATH }}
        run: |
          set -e
          mkdir -p data
          if [ -n "$EXCEL_PATH_INPUT" ] && echo "$EXCEL_PATH_INPUT" | grep -qiE '^https?://'; then
            echo "Downloading Excel from EXCEL_PATH_INPUT to data/cached_spreadsheet.xlsx"
            curl -L "$EXCEL_PATH_INPUT" -o data/cached_spreadsheet.xlsx
          else
            echo "No EXCEL_PATH URL provided; skipping download"
          fi

      - name: Deploy (project targeted, no link)
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: |
          set -e
          # Ensure token is present for CLI context
          if [ -z "$RAILWAY_TOKEN" ] && [ -n "$RAILWAY_API_TOKEN" ]; then
            export RAILWAY_TOKEN="$RAILWAY_API_TOKEN"
          fi
          railway up --detach --project "$RAILWAY_PROJECT_ID"
          echo "Deploy completed (fingerprint: v2-2025-12-05)."

      - name: Summary
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          echo "Workflow: Deploy to Railway v2"
          echo "Fingerprint: v2-2025-12-05"
          echo "Project: $RAILWAY_PROJECT_ID"
