name: Deploy to Railway

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Railway CLI
        run: npm i -g @railway/cli

      - name: Deploy using Railway CLI
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: |
          set -e
          if [ -n "$RAILWAY_TOKEN" ]; then
            echo "Using project token (RAILWAY_TOKEN)"
            railway up --detach
          elif [ -n "$RAILWAY_API_TOKEN" ]; then
            echo "Using account/team token (RAILWAY_API_TOKEN)"
            railway up --detach
          else
            echo "ERROR: Provide either RAILWAY_TOKEN (project token) or RAILWAY_API_TOKEN (account/team token) as a GitHub secret." >&2
            exit 1
          fi

      - name: Set environment variables
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
        run: |
          set -e
          # Authenticate is implicit via token env var
          railway variables set NODE_ENV=production
          railway variables set FORCE_LOCAL_EXCEL=1
          railway variables set EXCEL_PATH=./data/cached_spreadsheet.xlsx
          if [ -n "$SESSION_SECRET" ]; then
            railway variables set SESSION_SECRET="$SESSION_SECRET"
          else
            echo "SESSION_SECRET not set; using default in code. Consider adding it as a secret." >&2
          fi

      - name: Print healthcheck URL
        run: |
          echo "Healthcheck: /health (configured in railway.json)"