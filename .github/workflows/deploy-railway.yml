name: Deploy to Railway

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      EXCEL_DOWNLOAD_URL:
        description: 'Public XLSX export URL to use for deploy'
        required: false
        default: ''
      EXCEL_PATH:
        description: 'Excel path or public XLSX URL (server downloads when URL & FORCE_LOCAL_EXCEL=0)'
        required: false
        default: ''
      FORCE_LOCAL_EXCEL:
        description: 'Set 1 to force local file path; 0 allows URL download'
        required: false
        default: '0'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          persist-credentials: true
          clean: true
          lfs: true
          submodules: false

      - name: Mark workspace as safe directory (fix git 128)
        if: always()
        continue-on-error: true
        run: |
          git --version
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          # Add multiple potential workspace paths to safe.directory
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global --add safe.directory "/github/workspace"
          # Fallback to canonical runner path
          repo_name="${{ github.repository }}"
          base_name=$(basename "$GITHUB_WORKSPACE")
          git config --global --add safe.directory "/home/runner/work/${repo_name}/${base_name}"
          # Also add current pwd for safety
          git config --global --add safe.directory "$(pwd)"
          git config --global --list | sed -n 's/^safe\.directory=\(.*\)$/safe.directory=\1/p'
          # Sanity check to trigger git access early
          git status || true

      - name: Neutralize broken submodule config (prevent git 128 in post-job)
        if: always()
        continue-on-error: true
        run: |
          # If a stale .gitmodules exists without proper URLs, remove and deinit
          if [ -f .gitmodules ]; then
            echo "Found .gitmodules; printing contents:"
            cat .gitmodules || true
          fi
          # Avoid calling git submodule deinit which can error when URLs are missing.
          # Instead, remove any .gitmodules files and purge ALL local submodule config.
          # Remove tracked .gitmodules if present (avoid post-job deinit error)
          if git ls-files --error-unmatch .gitmodules >/dev/null 2>&1; then
            echo "Removing tracked .gitmodules from index"
            git rm -f --cached .gitmodules || true
          fi
          find . -name .gitmodules -type f -print -exec rm -f {} \; || true
          # Purge all submodule.* sections from local config
          sections=$(git config --local --name-only --get-regexp '^submodule\.' | sed -E 's/^(submodule\.[^\.]+).*$/\1/' | sort -u || true)
          for s in $sections; do
            echo "Removing config section: $s"
            git config --local --remove-section "$s" || true
          done
          # Best-effort deinit to ensure clean state (ignore errors)
          git submodule deinit -f --all || true
          # Status for visibility
          git config --local --list | sed -n 's/^submodule\..*/&/p' || true
          git status || true

      - name: Inject Railway token env for subsequent steps
        run: |
          if [ -n "${{ secrets.RAILWAY_TOKEN }}" ]; then
            echo "RAILWAY_TOKEN=${{ secrets.RAILWAY_TOKEN }}" >> $GITHUB_ENV
            echo "Using project token from RAILWAY_TOKEN"
          elif [ -n "${{ secrets.RAILWAY_API_TOKEN }}" ]; then
            # Map API token to RAILWAY_TOKEN since CLI primarily reads RAILWAY_TOKEN
            echo "RAILWAY_TOKEN=${{ secrets.RAILWAY_API_TOKEN }}" >> $GITHUB_ENV
            echo "RAILWAY_API_TOKEN=${{ secrets.RAILWAY_API_TOKEN }}" >> $GITHUB_ENV
            echo "Using account/team token mapped to RAILWAY_TOKEN"
          else
            echo "No Railway token secrets provided" >&2
          fi

      - name: Validate Railway token secrets
        run: |
          if [ -z "$RAILWAY_TOKEN" ] && [ -z "$RAILWAY_API_TOKEN" ]; then
            echo "ERROR: Defina RAILWAY_TOKEN (projeto) ou RAILWAY_API_TOKEN (conta/time) em GitHub Secrets."
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Railway CLI
        run: npm i -g @railway/cli

      - name: Authenticate Railway CLI with token
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: |
          set -e
          # Prefer project token; fallback to API token
          TOKEN="$RAILWAY_TOKEN"
          if [ -z "$TOKEN" ] && [ -n "$RAILWAY_API_TOKEN" ]; then
            TOKEN="$RAILWAY_API_TOKEN"
          fi
          if [ -n "$TOKEN" ]; then
            echo "Authenticating Railway CLI with token"
            railway login --token "$TOKEN" || {
              echo "ERROR: Falha ao autenticar com o token fornecido. Verifique se o token é válido e possui acesso ao projeto." >&2
              exit 1
            }
          else
            echo "ERROR: Nenhum token Railway fornecido." >&2
            exit 1
          fi

      - name: Ensure explicit project targeting when using API token
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          if [ -n "$RAILWAY_API_TOKEN" ] && [ -z "$RAILWAY_PROJECT_ID" ] && [ -z "$RAILWAY_TOKEN" ]; then
            echo "ERROR: RAILWAY_API_TOKEN está definido sem RAILWAY_PROJECT_ID."
            echo "Adicione o secret RAILWAY_PROJECT_ID (Project ID do Railway) para evitar deploy no projeto errado."
            echo "Para fixar em new-lokok-production: Settings → Secrets → Actions → New secret → RAILWAY_PROJECT_ID = <ID do projeto>."
            exit 1
          fi

      - name: Diagnose Railway CLI context (token, whoami, status)
        env:
          RAILWAY_TOKEN: ${{ env.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ env.RAILWAY_API_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          set -e
          # Ensure Railway CLI is available
          if ! command -v railway >/dev/null 2>&1; then
            echo "Railway CLI missing; installing..."
            npm i -g @railway/cli
          fi
          # Fallback: map API token to project token var for CLI compatibility
          if [ -z "$RAILWAY_TOKEN" ] && [ -n "$RAILWAY_API_TOKEN" ]; then
            export RAILWAY_TOKEN="$RAILWAY_API_TOKEN"
            echo "Fallback: mapped RAILWAY_API_TOKEN -> RAILWAY_TOKEN"
          fi
          railway --version
          echo "Token present: $([ -n "$RAILWAY_TOKEN" ] && echo yes || echo no)"
          # Validate authentication and project accessibility without interactive link
          railway whoami || {
            echo "ERROR: Não autenticado; verifique o token (RAILWAY_TOKEN/RAILWAY_API_TOKEN)." >&2
            exit 1
          }
          if [ -n "$RAILWAY_PROJECT_ID" ]; then
            railway status --project "$RAILWAY_PROJECT_ID" || {
              echo "ERROR: Projeto inacessível com o token atual. Confirme RAILWAY_PROJECT_ID e permissões do token." >&2
              exit 1
            }
          else
            echo "AVISO: RAILWAY_PROJECT_ID não definido; usando contexto padrão do CLI."
            railway status || true
          fi

      - name: Verify Railway project context
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: |
          set -e
          # Ensure CLI available
          command -v railway >/dev/null 2>&1 || npm i -g @railway/cli
          railway --version
          # Check whoami
          railway whoami || {
            echo "ERROR: Não autenticado; verifique o token." >&2
            exit 1
          }
          # If project id provided, verify project is accessible
          if [ -n "$RAILWAY_PROJECT_ID" ]; then
            echo "Checking project context via status --project"
            railway status --project "$RAILWAY_PROJECT_ID" || {
              echo "ERROR: Projeto inacessível com o token atual. Confirme RAILWAY_PROJECT_ID e permissões do token." >&2
              exit 1
            }
          fi

      - name: Assert target project/domain before deploy
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          set -e
          # Ensure Railway CLI is available
          if ! command -v railway >/dev/null 2>&1; then
            npm i -g @railway/cli
          fi
          echo "Verifying target domain new-lokok-production..."
          if ! railway domain list --project "$RAILWAY_PROJECT_ID" 2>/dev/null | grep -qi 'new-lokok-production'; then
            echo "ERROR: Domínio new-lokok-production não encontrado no projeto corrente." >&2
            echo "Dicas:"
            echo "- Garanta que RAILWAY_PROJECT_ID aponte para o projeto new-lokok-production."
            echo "- Ou use RAILWAY_TOKEN (token de projeto) do new-lokok-production."
            echo "- Verifique se o link ao projeto ocorreu sem erros nas etapas anteriores."
            exit 1
          fi

      - name: Install Excel dependency (xlsx)
        run: npm i xlsx

      - name: Generate empty reset Excel (US and CN)
        run: |
          set -e
          node scripts/create_empty_excel.js
          ls -lh data || true

      - name: Set environment variables (before deploy)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          DEFAULT_ADMIN_ALLOWED_COUNTRIES: ${{ secrets.DEFAULT_ADMIN_ALLOWED_COUNTRIES }}
          GOOGLE_DRIVE_FILE_ID: ${{ secrets.GOOGLE_DRIVE_FILE_ID }}
          GOOGLE_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          EXCEL_DOWNLOAD_URL_INPUT: ${{ github.event.inputs.EXCEL_DOWNLOAD_URL }}
          EXCEL_PATH_INPUT: ${{ github.event.inputs.EXCEL_PATH }}
          FORCE_LOCAL_EXCEL_INPUT: ${{ github.event.inputs.FORCE_LOCAL_EXCEL }}
        run: |
          set -e
          # Ensure Railway CLI is available
          if ! command -v railway >/dev/null 2>&1; then
            echo "Railway CLI missing; installing..."
            npm i -g @railway/cli
          fi
          # Fallback: map API token to project token var for CLI compatibility
          if [ -z "$RAILWAY_TOKEN" ] && [ -n "$RAILWAY_API_TOKEN" ]; then
            export RAILWAY_TOKEN="$RAILWAY_API_TOKEN"
            echo "Fallback: mapped RAILWAY_API_TOKEN -> RAILWAY_TOKEN"
          fi
          # Authenticate is implicit via token env var
          # Configure database usage automatically when DATABASE_URL is provided
          if [ -n "$DATABASE_URL" ]; then
            railway variables --project "${{ secrets.RAILWAY_PROJECT_ID }}" USE_DB=true
            railway variables --project "${{ secrets.RAILWAY_PROJECT_ID }}" DATABASE_URL="$DATABASE_URL"
            echo "USE_DB=true (DATABASE_URL secret detected)"
          else
            railway variables --project "${{ secrets.RAILWAY_PROJECT_ID }}" USE_DB=false
            echo "USE_DB=false (no DATABASE_URL secret)"
          fi
          railway variables --project "${{ secrets.RAILWAY_PROJECT_ID }}" NODE_ENV=production
          # Default to local Excel; will switch to Drive automatically if Drive secret is present
          if [ -n "$FORCE_LOCAL_EXCEL_INPUT" ]; then
            railway variables --project "${{ secrets.RAILWAY_PROJECT_ID }}" FORCE_LOCAL_EXCEL="$FORCE_LOCAL_EXCEL_INPUT"
            echo "FORCE_LOCAL_EXCEL set from workflow input"
          else
            echo "FORCE_LOCAL_EXCEL input empty; leaving existing variable unchanged for now"
          fi
          if [ -n "$EXCEL_PATH_INPUT" ]; then
            railway variables --project "${{ secrets.RAILWAY_PROJECT_ID }}" EXCEL_PATH="$EXCEL_PATH_INPUT"
            echo "Using EXCEL_PATH from workflow input"
          else
            echo "EXCEL_PATH input empty; leaving existing variable unchanged"
          fi
          if [ -n "$SESSION_SECRET" ]; then
            railway variables --project "${{ secrets.RAILWAY_PROJECT_ID }}" SESSION_SECRET="$SESSION_SECRET"
          else
            echo "SESSION_SECRET not set; using default in code. Consider adding it as a secret." >&2
          fi
          # Google Drive credentials (optional)
          if [ -n "$GOOGLE_DRIVE_FILE_ID" ]; then
            railway variables --project "${{ secrets.RAILWAY_PROJECT_ID }}" GOOGLE_DRIVE_FILE_ID="$GOOGLE_DRIVE_FILE_ID"
            echo "GOOGLE_DRIVE_FILE_ID detected; Drive enabled"
            # Auto-toggle: prefer Drive source when Drive file is configured
            railway variables --project "${{ secrets.RAILWAY_PROJECT_ID }}" FORCE_LOCAL_EXCEL=0
            echo "FORCE_LOCAL_EXCEL=0 (auto) due to Drive secret present"
          else
            railway variables --project "${{ secrets.RAILWAY_PROJECT_ID }}" GOOGLE_DRIVE_FILE_ID=
            echo "GOOGLE_DRIVE_FILE_ID not set; staying on local/public Excel path." >&2
            # If no explicit input provided, ensure local Excel mode
            if [ -z "$FORCE_LOCAL_EXCEL_INPUT" ]; then
              railway variables --project "${{ secrets.RAILWAY_PROJECT_ID }}" FORCE_LOCAL_EXCEL=1
              echo "FORCE_LOCAL_EXCEL=1 (auto) because Drive secret is absent"
            fi
          fi
          if [ -n "$GOOGLE_SERVICE_ACCOUNT_EMAIL" ]; then
            railway variables --project "${{ secrets.RAILWAY_PROJECT_ID }}" GOOGLE_SERVICE_ACCOUNT_EMAIL="$GOOGLE_SERVICE_ACCOUNT_EMAIL"
          fi
          if [ -n "$GOOGLE_PRIVATE_KEY" ]; then
            railway variables --project "${{ secrets.RAILWAY_PROJECT_ID }}" GOOGLE_PRIVATE_KEY="$GOOGLE_PRIVATE_KEY"
          fi

          # Service account is optional when file is public; if provided, it enables private files

          # Country list (fallback to default if secret missing)
          if [ -n "$DEFAULT_ADMIN_ALLOWED_COUNTRIES" ]; then
            railway variables --project "${{ secrets.RAILWAY_PROJECT_ID }}" DEFAULT_ADMIN_ALLOWED_COUNTRIES="$DEFAULT_ADMIN_ALLOWED_COUNTRIES"
          else
            railway variables --project "${{ secrets.RAILWAY_PROJECT_ID }}" DEFAULT_ADMIN_ALLOWED_COUNTRIES="US,CA,MX"
          fi

      - name: Summary (effective toggles)
        run: |
          echo "Summary of effective data-source configuration:"
          echo "- DATABASE_URL secret: ${{ secrets.DATABASE_URL != '' && 'SET' || 'EMPTY' }}"
          echo "- USE_DB: auto (true when DATABASE_URL set; false otherwise)"
          echo "- GOOGLE_DRIVE_FILE_ID: ${{ secrets.GOOGLE_DRIVE_FILE_ID != '' && 'SET' || 'EMPTY' }}"
          echo "- FORCE_LOCAL_EXCEL: ${{ github.event.inputs.FORCE_LOCAL_EXCEL != '' && github.event.inputs.FORCE_LOCAL_EXCEL || 'auto (0 with Drive, 1 without)' }}"

      - name: Target project and domains summary
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          set -e
          # Ensure Railway CLI is available
          if ! command -v railway >/dev/null 2>&1; then
            echo "Railway CLI missing; installing..."
            npm i -g @railway/cli
          fi
          # Fallback: map API token to project token var for CLI compatibility
          if [ -z "$RAILWAY_TOKEN" ] && [ -n "$RAILWAY_API_TOKEN" ]; then
            export RAILWAY_TOKEN="$RAILWAY_API_TOKEN"
            echo "Fallback: mapped RAILWAY_API_TOKEN -> RAILWAY_TOKEN"
          fi
          echo "==== Railway Target Summary ===="
          echo "Project ID (secret): ${RAILWAY_PROJECT_ID:-(none)}"
          echo "Whoami:"
          railway whoami || true
          echo "Project info:"
          railway project --project "$RAILWAY_PROJECT_ID" || true
          echo "Domains:"
          railway domain list --project "$RAILWAY_PROJECT_ID" || true
          echo "Check for new-lokok-production domain:"
          railway domain list --project "$RAILWAY_PROJECT_ID" 2>/dev/null | grep -i 'new-lokok-production' && echo "Detected new-lokok-production domain" || echo "new-lokok-production domain not detected in current project"
          echo "- EXCEL_PATH input: ${{ github.event.inputs.EXCEL_PATH }}"

      - name: Download Excel file for exact local parity (optional)
        env:
          EXCEL_PATH_INPUT: ${{ github.event.inputs.EXCEL_PATH }}
        run: |
          set -e
          mkdir -p data
          if [ -n "$EXCEL_PATH_INPUT" ] && echo "$EXCEL_PATH_INPUT" | grep -qiE '^https?://'; then
            echo "Downloading Excel from EXCEL_PATH_INPUT to data/cached_spreadsheet.xlsx"
            curl -L "$EXCEL_PATH_INPUT" -o data/cached_spreadsheet.xlsx
            ls -lh data || true
          else
            echo "No EXCEL_PATH URL provided; skipping optional local parity download"
          fi

      - name: Deploy using Railway CLI (with variables set)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          set -e
          # Ensure Railway CLI is available
          if ! command -v railway >/dev/null 2>&1; then
            echo "Railway CLI missing; installing..."
            npm i -g @railway/cli
          fi
          # Fallback: map API token to project token var for CLI compatibility
          if [ -z "$RAILWAY_TOKEN" ] && [ -n "$RAILWAY_API_TOKEN" ]; then
            export RAILWAY_TOKEN="$RAILWAY_API_TOKEN"
            echo "Fallback: mapped RAILWAY_API_TOKEN -> RAILWAY_TOKEN"
          fi
          railway whoami || true
          railway status --project "$RAILWAY_PROJECT_ID" || true
          if [ -n "$RAILWAY_TOKEN" ]; then
            echo "Using project token (RAILWAY_TOKEN)"
            railway up --detach --project "$RAILWAY_PROJECT_ID"
          elif [ -n "$RAILWAY_API_TOKEN" ]; then
            echo "Using account/team token (RAILWAY_API_TOKEN)"
            if [ -z "$RAILWAY_PROJECT_ID" ]; then
              echo "ERROR: Defina RAILWAY_PROJECT_ID para direcionar o deploy ao projeto correto com token de conta/time." >&2
              exit 1
            fi
            railway up --detach --project "$RAILWAY_PROJECT_ID"
          else
            echo "ERROR: Provide either RAILWAY_TOKEN (project token) or RAILWAY_API_TOKEN (account/team token) as a GitHub secret." >&2
            exit 1
          fi

      - name: Print healthcheck URL
        run: |
          echo "Healthcheck: /health (configured in railway.json)"
