name: Set Railway Variables

on:
  workflow_dispatch:
    inputs:
      USE_DB:
        description: 'USE_DB (true=usa banco, false=Excel/Drive)'
        required: false
        default: 'false'
      NODE_ENV:
        description: 'NODE_ENV (default: production)'
        required: false
        default: 'production'
      FORCE_LOCAL_EXCEL:
        description: 'FORCE_LOCAL_EXCEL (1=força arquivo local, 0=permite URL)'
        required: false
        default: '1'
      EXCEL_PATH:
        description: 'Caminho do Excel ou URL pública XLSX'
        required: false
        default: './data/cached_spreadsheet.xlsx'
      DATABASE_URL:
        description: 'DATABASE_URL (opcional: define e ativa USE_DB=true quando presente)'
        required: false
        default: ''
      SESSION_SECRET:
        description: 'Override de SESSION_SECRET (vazio para não alterar)'
        required: false
        default: ''
      GOOGLE_DRIVE_FILE_ID:
        description: 'ID do arquivo no Google Drive (opcional)'
        required: false
        default: ''
      GOOGLE_SERVICE_ACCOUNT_EMAIL:
        description: 'Email da service account (opcional)'
        required: false
        default: ''
      GOOGLE_PRIVATE_KEY:
        description: 'Private key da service account (opcional)'
        required: false
        default: ''
      DEFAULT_ADMIN_ALLOWED_COUNTRIES:
        description: 'Países permitidos (default: US,CA,MX)'
        required: false
        default: 'US,CA,MX'

jobs:
  set-vars:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Inject Railway token env
        run: |
          if [ -n "${{ secrets.RAILWAY_TOKEN }}" ]; then
            echo "RAILWAY_TOKEN=${{ secrets.RAILWAY_TOKEN }}" >> $GITHUB_ENV
            echo "Using project token from RAILWAY_TOKEN"
          elif [ -n "${{ secrets.RAILWAY_API_TOKEN }}" ]; then
            echo "RAILWAY_TOKEN=${{ secrets.RAILWAY_API_TOKEN }}" >> $GITHUB_ENV
            echo "RAILWAY_API_TOKEN=${{ secrets.RAILWAY_API_TOKEN }}" >> $GITHUB_ENV
            echo "Using account/team token mapped to RAILWAY_TOKEN"
          else
            echo "No Railway token secrets provided" >&2
          fi

      - name: Validate tokens
        run: |
          if [ -z "$RAILWAY_TOKEN" ] && [ -z "$RAILWAY_API_TOKEN" ]; then
            echo "ERROR: Defina RAILWAY_TOKEN (projeto) ou RAILWAY_API_TOKEN (conta/time) em GitHub Secrets."
            exit 1
          fi

      - name: Ensure explicit project targeting when using API token
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
        run: |
          if [ -n "$RAILWAY_API_TOKEN" ] && [ -z "$RAILWAY_PROJECT_ID" ] && [ -z "$RAILWAY_TOKEN" ]; then
            echo "ERROR: RAILWAY_API_TOKEN está definido sem RAILWAY_PROJECT_ID."
            echo "Adicione o secret RAILWAY_PROJECT_ID (Project ID do Railway) para evitar alterar variáveis no projeto errado."
            echo "Para fixar em new-lokok-production: Settings → Secrets → Actions → New secret → RAILWAY_PROJECT_ID = <ID do projeto>."
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Railway CLI
        run: |
          npm i -g @railway/cli
          railway --version

      - name: Authenticate Railway CLI with token
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: |
          set -e
          TOKEN="$RAILWAY_TOKEN"
          if [ -z "$TOKEN" ] && [ -n "$RAILWAY_API_TOKEN" ]; then
            TOKEN="$RAILWAY_API_TOKEN"
          fi
          if [ -n "$TOKEN" ]; then
            echo "Authenticating Railway CLI with token"
            railway login --token "$TOKEN" || {
              echo "ERROR: Falha ao autenticar com o token fornecido. Verifique se o token é válido e possui acesso ao projeto." >&2
              exit 1
            }
          else
            echo "ERROR: Nenhum token Railway fornecido." >&2
            exit 1
          fi

      - name: Verify Railway project context
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: |
          set -e
          # Ensure Railway CLI is available
          if ! command -v railway >/dev/null 2>&1; then
            echo "Railway CLI missing; installing..."
            npm i -g @railway/cli
          fi
          railway whoami || {
            echo "ERROR: Não autenticado; verifique o token." >&2
            exit 1
          }
          if [ -n "$RAILWAY_PROJECT_ID" ]; then
            railway status --project "$RAILWAY_PROJECT_ID" || {
              echo "ERROR: Projeto inacessível com o token atual. Confirme RAILWAY_PROJECT_ID e permissões do token." >&2
              exit 1
            }
          else
            echo "AVISO: RAILWAY_PROJECT_ID não definido; os comandos usarão o contexto padrão do CLI."
          fi

      - name: Assert target domain before setting variables
        run: |
          set -e
          if ! command -v railway >/dev/null 2>&1; then
            npm i -g @railway/cli
          fi
          if ! railway domain list --project "${{ secrets.RAILWAY_PROJECT_ID }}" 2>/dev/null | grep -qi 'new-lokok-production'; then
            echo "ERROR: Domínio new-lokok-production não encontrado no projeto corrente (antes de setar variáveis)." >&2
            echo "Garanta que o projeto esteja corretamente vinculado (RAILWAY_PROJECT_ID / RAILWAY_TOKEN)." >&2
            exit 1
          fi

      - name: Set Railway variables
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          INPUT_USE_DB: ${{ github.event.inputs.USE_DB }}
          INPUT_NODE_ENV: ${{ github.event.inputs.NODE_ENV }}
          INPUT_FORCE_LOCAL_EXCEL: ${{ github.event.inputs.FORCE_LOCAL_EXCEL }}
          INPUT_EXCEL_PATH: ${{ github.event.inputs.EXCEL_PATH }}
          INPUT_SESSION_SECRET: ${{ github.event.inputs.SESSION_SECRET }}
          INPUT_DATABASE_URL: ${{ github.event.inputs.DATABASE_URL }}
          INPUT_GOOGLE_DRIVE_FILE_ID: ${{ github.event.inputs.GOOGLE_DRIVE_FILE_ID }}
          INPUT_GOOGLE_SERVICE_ACCOUNT_EMAIL: ${{ github.event.inputs.GOOGLE_SERVICE_ACCOUNT_EMAIL }}
          INPUT_GOOGLE_PRIVATE_KEY: ${{ github.event.inputs.GOOGLE_PRIVATE_KEY }}
          INPUT_DEFAULT_ADMIN_ALLOWED_COUNTRIES: ${{ github.event.inputs.DEFAULT_ADMIN_ALLOWED_COUNTRIES }}
          GOOGLE_DRIVE_FILE_ID_SECRET: ${{ secrets.GOOGLE_DRIVE_FILE_ID }}
          DATABASE_URL_SECRET: ${{ secrets.DATABASE_URL }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: |
          set -e
          # Ensure Railway CLI is available
          if ! command -v railway >/dev/null 2>&1; then
            echo "Railway CLI missing; installing..."
            npm i -g @railway/cli
          fi
          if [ -z "$RAILWAY_TOKEN" ] && [ -n "$RAILWAY_API_TOKEN" ]; then
            export RAILWAY_TOKEN="$RAILWAY_API_TOKEN"
            echo "Fallback: mapped RAILWAY_API_TOKEN -> RAILWAY_TOKEN"
          fi
          # Required/defaulted variables
          railway variables --project "$RAILWAY_PROJECT_ID" NODE_ENV="${INPUT_NODE_ENV:-production}"
          # FORCE_LOCAL_EXCEL: set only if input is provided; otherwise auto-toggle later based on Drive ID
          if [ -n "$INPUT_FORCE_LOCAL_EXCEL" ]; then
            railway variables --project "$RAILWAY_PROJECT_ID" FORCE_LOCAL_EXCEL="$INPUT_FORCE_LOCAL_EXCEL"
            echo "FORCE_LOCAL_EXCEL set from input: $INPUT_FORCE_LOCAL_EXCEL"
          else
            echo "FORCE_LOCAL_EXCEL left unchanged here; will auto-toggle based on Drive ID."
          fi
          railway variables --project "$RAILWAY_PROJECT_ID" EXCEL_PATH="${INPUT_EXCEL_PATH:-./data/cached_spreadsheet.xlsx}"
          railway variables --project "$RAILWAY_PROJECT_ID" DEFAULT_ADMIN_ALLOWED_COUNTRIES="${INPUT_DEFAULT_ADMIN_ALLOWED_COUNTRIES:-US,CA,MX}"

          # Database URL and USE_DB handling
          FINAL_DB_URL="${INPUT_DATABASE_URL:-$DATABASE_URL_SECRET}"
          if [ -n "$FINAL_DB_URL" ]; then
            railway variables --project "$RAILWAY_PROJECT_ID" DATABASE_URL="$FINAL_DB_URL"
            echo "DATABASE_URL set."
          fi
          if [ -n "$INPUT_USE_DB" ]; then
            railway variables --project "$RAILWAY_PROJECT_ID" USE_DB="$INPUT_USE_DB"
            echo "USE_DB set from input: $INPUT_USE_DB"
          else
            if [ -n "$FINAL_DB_URL" ]; then
              railway variables --project "$RAILWAY_PROJECT_ID" USE_DB=true
              echo "USE_DB=TRUE (auto) because DATABASE_URL provided."
            else
              railway variables --project "$RAILWAY_PROJECT_ID" USE_DB=false
              echo "USE_DB=FALSE (auto) because DATABASE_URL absent."
            fi
          fi

          # Optional overrides (only set when provided)
          if [ -n "$INPUT_SESSION_SECRET" ]; then
            railway variables --project "$RAILWAY_PROJECT_ID" SESSION_SECRET="$INPUT_SESSION_SECRET"
          else
            echo "SESSION_SECRET left unchanged (using existing secret or default)."
          fi
          # Drive ID: prefer input, otherwise use secret; auto-toggle FORCE_LOCAL_EXCEL accordingly when no explicit input
          FINAL_DRIVE_ID="${INPUT_GOOGLE_DRIVE_FILE_ID:-$GOOGLE_DRIVE_FILE_ID_SECRET}"
          if [ -n "$FINAL_DRIVE_ID" ]; then
            railway variables --project "$RAILWAY_PROJECT_ID" GOOGLE_DRIVE_FILE_ID="$FINAL_DRIVE_ID"
            echo "GOOGLE_DRIVE_FILE_ID set (Drive enabled)."
            if [ -z "$INPUT_FORCE_LOCAL_EXCEL" ]; then
              railway variables --project "$RAILWAY_PROJECT_ID" FORCE_LOCAL_EXCEL=0
              echo "FORCE_LOCAL_EXCEL=0 (auto) due to Drive ID present."
            fi
          else
            railway variables --project "$RAILWAY_PROJECT_ID" GOOGLE_DRIVE_FILE_ID=
            echo "GOOGLE_DRIVE_FILE_ID empty; Drive disabled."
            if [ -z "$INPUT_FORCE_LOCAL_EXCEL" ]; then
              railway variables --project "$RAILWAY_PROJECT_ID" FORCE_LOCAL_EXCEL=1
              echo "FORCE_LOCAL_EXCEL=1 (auto) because Drive ID absent."
            fi
          fi
          if [ -n "$INPUT_GOOGLE_SERVICE_ACCOUNT_EMAIL" ]; then
            railway variables --project "$RAILWAY_PROJECT_ID" GOOGLE_SERVICE_ACCOUNT_EMAIL="$INPUT_GOOGLE_SERVICE_ACCOUNT_EMAIL"
          fi
          if [ -n "$INPUT_GOOGLE_PRIVATE_KEY" ]; then
            railway variables --project "$RAILWAY_PROJECT_ID" GOOGLE_PRIVATE_KEY="$INPUT_GOOGLE_PRIVATE_KEY"
          fi

      - name: Summary
        run: |
          echo "Variables set:"
          echo "- USE_DB=${{ github.event.inputs.USE_DB }} (auto true when DATABASE_URL present and no input)"
          echo "- DATABASE_URL=${{ github.event.inputs.DATABASE_URL != '' && 'FROM INPUT' || (secrets.DATABASE_URL != '' && 'FROM SECRET' || 'EMPTY') }}"
          echo "- NODE_ENV=${{ github.event.inputs.NODE_ENV }}"
          echo "- FORCE_LOCAL_EXCEL=${{ github.event.inputs.FORCE_LOCAL_EXCEL }} (auto when Drive ID present/absent and no input)"
          echo "- EXCEL_PATH=${{ github.event.inputs.EXCEL_PATH }}"
          echo "- DEFAULT_ADMIN_ALLOWED_COUNTRIES=${{ github.event.inputs.DEFAULT_ADMIN_ALLOWED_COUNTRIES }}"
          echo "Optionals: SESSION_SECRET, GOOGLE_DRIVE_FILE_ID (input/secret), GOOGLE_SERVICE_ACCOUNT_EMAIL, GOOGLE_PRIVATE_KEY"
