name: Deploy to Railway

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Railway CLI
        run: npm i -g @railway/cli

      - name: Deploy using Railway CLI
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
        run: |
          set -e
          if [ -n "$RAILWAY_TOKEN" ]; then
            echo "Using project token (RAILWAY_TOKEN)"
            railway up --detach
          elif [ -n "$RAILWAY_API_TOKEN" ]; then
            echo "Using account/team token (RAILWAY_API_TOKEN)"
            railway up --detach
          else
            echo "ERROR: Provide either RAILWAY_TOKEN (project token) or RAILWAY_API_TOKEN (account/team token) as a GitHub secret." >&2
            exit 1
          fi

      - name: Set environment variables
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_API_TOKEN }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          DEFAULT_ADMIN_ALLOWED_COUNTRIES: ${{ secrets.DEFAULT_ADMIN_ALLOWED_COUNTRIES }}
          GOOGLE_DRIVE_FILE_ID: ${{ secrets.GOOGLE_DRIVE_FILE_ID }}
          GOOGLE_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_EMAIL }}
          GOOGLE_PRIVATE_KEY: ${{ secrets.GOOGLE_PRIVATE_KEY }}
        run: |
          set -e
          # Authenticate is implicit via token env var
          railway variables set NODE_ENV=production
          # Default to local Excel; will switch to Drive if credentials provided
          railway variables set FORCE_LOCAL_EXCEL=1
          railway variables set EXCEL_PATH=./data/lokok2-export-US-20251119.xlsx
          if [ -n "$SESSION_SECRET" ]; then
            railway variables set SESSION_SECRET="$SESSION_SECRET"
          else
            echo "SESSION_SECRET not set; using default in code. Consider adding it as a secret." >&2
          fi
          # Google Drive credentials (optional)
          if [ -n "$GOOGLE_DRIVE_FILE_ID" ]; then
            railway variables set GOOGLE_DRIVE_FILE_ID="$GOOGLE_DRIVE_FILE_ID"
            # If a public Drive file ID is present, prefer Drive even without service account
            railway variables set FORCE_LOCAL_EXCEL=0
            echo "GOOGLE_DRIVE_FILE_ID detected; using Drive (FORCE_LOCAL_EXCEL=0)"
          else
            echo "GOOGLE_DRIVE_FILE_ID not set; staying on local Excel unless overridden." >&2
          fi
          if [ -n "$GOOGLE_SERVICE_ACCOUNT_EMAIL" ]; then
            railway variables set GOOGLE_SERVICE_ACCOUNT_EMAIL="$GOOGLE_SERVICE_ACCOUNT_EMAIL"
          fi
          if [ -n "$GOOGLE_PRIVATE_KEY" ]; then
            railway variables set GOOGLE_PRIVATE_KEY="$GOOGLE_PRIVATE_KEY"
          fi

          # Service account is optional when file is public; if provided, it enables private files

          # Country list (fallback to default if secret missing)
          if [ -n "$DEFAULT_ADMIN_ALLOWED_COUNTRIES" ]; then
            railway variables set DEFAULT_ADMIN_ALLOWED_COUNTRIES="$DEFAULT_ADMIN_ALLOWED_COUNTRIES"
          else
            railway variables set DEFAULT_ADMIN_ALLOWED_COUNTRIES="US,CA,MX"
          fi

      - name: Summary (effective toggles)
        run: |
          echo "Summary of effective data-source configuration:"
          echo "- GOOGLE_DRIVE_FILE_ID: ${{ secrets.GOOGLE_DRIVE_FILE_ID != '' && 'SET' || 'EMPTY' }}"
          echo "- FORCE_LOCAL_EXCEL:  ${{ secrets.GOOGLE_DRIVE_FILE_ID != '' && '0 (auto) with Drive' || '1 (auto) without Drive' }}"
          echo "- EXCEL_PATH (default in workflow): ./data/lokok2-export-US-20251119.xlsx"

      - name: Print healthcheck URL
        run: |
          echo "Healthcheck: /health (configured in railway.json)"
