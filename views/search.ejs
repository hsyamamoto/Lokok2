<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search - Registration System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&family=Geist+Mono:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Geist', 'system-ui', 'sans-serif'],
                        'mono': ['Geist Mono', 'monospace']
                    },
                    fontSize: {
                        'base': '16px'
                    }
                }
            }
        }
    </script>
    <style>
        /* Fallback para grid caso Tailwind não carregue */
        .results-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        @media (min-width: 768px) { .results-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
        @media (min-width: 1024px) { .results-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 to-purple-600 min-h-screen font-sans text-base">
    <nav class="bg-sky-100/80 backdrop-blur-md border-b border-sky-200/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="/dashboard" class="flex items-center text-sky-800 text-xl font-bold hover:text-sky-600 transition-colors">
                    <i class="fas fa-search mr-2"></i>Search System
                </a>
                <div class="flex items-center space-x-4">
                    <a href="/dashboard" class="text-sky-800 hover:text-sky-900 px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200">
                        <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                    </a>
                    <a href="/form" class="text-sky-800 hover:text-sky-900 px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200">
                        <i class="fas fa-plus mr-2"></i>Add
                    </a>
                    <% if (user && user.role === 'admin') { %>
                    <a href="/users" class="text-sky-800 hover:text-sky-900 px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200">
                        <i class="fas fa-users mr-2"></i>Users
                    </a>
                    <% } %>
                    <span class="text-sky-700 text-sm">
                        <i class="fas fa-user mr-1"></i>Hello, <%= user.name %>
                        <span class="bg-sky-200 text-sky-800 px-2 py-1 rounded-full text-xs ml-2"><%= user.role.toUpperCase() %></span>
                    </span>
                    <a href="/logout" class="text-sky-700 hover:text-sky-900 text-sm transition-colors">
                        <i class="fas fa-sign-out-alt mr-1"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Search Form -->
        <div class="mb-8">
            <div class="bg-white rounded-2xl shadow-xl border-0 overflow-hidden">
                <div class="bg-gradient-to-r from-sky-200 to-blue-200 px-6 py-4">
                    <h2 class="text-xl font-semibold text-sky-800 mb-0">
                        <i class="fas fa-search mr-2"></i>Search Records
                    </h2>
                </div>
                <div class="p-6">
                    <form method="GET" action="/search">
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                            <div class="md:col-span-8">
                                <label for="query" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-keyboard mr-2"></i>Search term
                                </label>
                                <input type="text" id="query" name="query" 
                                       value="<%= query %>" placeholder="Type what you want to search..."
                                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-sky-300 focus:ring-0 transition-colors">
                                <div class="mt-3"><!-- moved listAll checkbox below the 'Search in' select for better symmetry --></div>
                            </div>
                            <input type="hidden" name="submitted" value="1" />
                            
                            <div class="md:col-span-4">
                                <label for="type" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-filter mr-2"></i>Search in
                                </label>
                                <select id="type" name="type" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-sky-300 focus:ring-0 transition-colors">
                                    <option value="all" <%= type === 'all' ? 'selected' : '' %>>All fields</option>
                                    <option value="name" <%= type === 'name' ? 'selected' : '' %>>Company Name</option>
                                    <option value="website" <%= type === 'website' ? 'selected' : '' %>>Website</option>
                                    <option value="categoria" <%= type === 'categoria' ? 'selected' : '' %>>Category</option>
                                </select>
                                <div class="mt-3">
                                    <label class="inline-flex items-center space-x-2">
                                        <input type="checkbox" name="listAll" value="1" <%= (typeof listAll === 'undefined' || listAll === '1') ? 'checked' : '' %> />
                                        <span class="text-sm text-gray-700"><i class="fas fa-list mr-1"></i>List ALL distributors</span>
                                    </label>
                                </div>
                            </div>
                            <div class="md:col-span-12 grid grid-cols-2 gap-4 items-center">
                                <button type="submit" class="w-full inline-flex items-center justify-center bg-sky-300 hover:bg-sky-400 text-sky-800 px-4 py-3 rounded-xl font-medium transition-all duration-300 hover:-translate-y-1 hover:shadow-lg">
                                    <i class="fas fa-search mr-2"></i>Search
                                </button>
                                <a href="/dashboard" class="w-full inline-flex items-center justify-center bg-slate-300 hover:bg-slate-400 text-slate-800 px-4 py-3 rounded-xl font-medium transition-all duration-300 hover:-translate-y-1 hover:shadow-lg text-center">
                                    <i class="fas fa-arrow-left mr-2"></i>Back
                                </a>
                            </div>
                        </div>
                     </form>
                </div>
            </div>
        </div>
        
        <!-- Results -->
        <% /* Mostrar resultados somente após o usuário enviar a busca (submitted) OU quando houver query/filtros */ %>
        <% const hasAnyFilterOrQuery = ((query || '').trim().length > 0) ||
               ((typeof buyer !== 'undefined') && ((buyer || '').trim().length > 0)) ||
               ((typeof category !== 'undefined') && ((category || '').trim().length > 0)) ||
               ((typeof accountStatus !== 'undefined') && ((accountStatus || '').trim().length > 0)) ||
               ((typeof status !== 'undefined') && ((status || '').trim().length > 0)) ||
               ((typeof submitted !== 'undefined') && (submitted === '1')); %>
        <% if (hasAnyFilterOrQuery) { %>
        
        <!-- Debug Counts Panel removido: agora disponível na aba LOGs -->
        
        <!-- Advanced Filters -->
        <div class="bg-white rounded-2xl shadow-xl border-0 overflow-hidden mb-6">
            <div class="bg-gradient-to-r from-sky-200 to-blue-200 px-6 py-4">
                <h2 class="text-xl font-semibold text-sky-800 mb-0">
                    <i class="fas fa-filter mr-2"></i>Advanced Filters
                </h2>
            </div>
            <div class="p-6">
                <form method="GET" action="/search" class="grid grid-cols-1 md:grid-cols-12 gap-4">
                    <input type="hidden" name="query" value="<%= query %>" />
                    <input type="hidden" name="type" value="<%= type %>" />
                    <input type="hidden" name="submitted" value="1" />
                    <input type="hidden" name="listAll" value="<%= listAll === '1' ? '1' : '' %>" />

                    <div class="md:col-span-3">
                        <label for="buyer" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user-tie mr-2"></i>Manager/Buyer
                        </label>
                        <select id="buyer" name="buyer" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-sky-300 focus:ring-0 transition-colors">
                            <option value="">Any</option>
                            <option value="__blank__" <%= (typeof buyer !== 'undefined' && buyer === '__blank__') ? 'selected' : '' %>>Blank (empty)</option>
                            <% if (Array.isArray(managersList)) { %>
                                <% managersList.forEach(function(m) { %>
                                    <option value="<%= m %>" <%= (typeof buyer !== 'undefined' && buyer === m) ? 'selected' : '' %>><%= m %></option>
                                <% }) %>
                            <% } %>
                        </select>
                    </div>

                    <div class="md:col-span-3">
                        <label for="accountStatus" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user-check mr-2"></i>Account Status
                        </label>
                        <select id="accountStatus" name="accountStatus" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-sky-300 focus:ring-0 transition-colors">
                            <option value="">Any</option>
                            <option value="__blank__" <%= (typeof accountStatus !== 'undefined' && accountStatus === '__blank__') ? 'selected' : '' %>>Blank (empty)</option>
                            <% if (Array.isArray(accountStatusList)) { %>
                                <% accountStatusList.forEach(function(s) { %>
                                    <option value="<%= s %>" <%= (typeof accountStatus !== 'undefined' && accountStatus === s) ? 'selected' : '' %>><%= s %></option>
                                <% }) %>
                            <% } %>
                        </select>
                    </div>

                    <div class="md:col-span-3">
                        <label for="category" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-tag mr-2"></i>Category
                        </label>
                        <input type="text" id="category" name="category" value="<%= typeof category !== 'undefined' ? category : '' %>"
                               placeholder="Type a category" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-sky-300 focus:ring-0 transition-colors">
                    </div>


                    <div class="md:col-span-3">
                        <label for="status" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-flag mr-2"></i>Status
                        </label>
                        <select id="status" name="status" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-sky-300 focus:ring-0 transition-colors">
                            <option value="" <%= (typeof status === 'undefined' || status === '') ? 'selected' : '' %>>Any</option>
                            <option value="__blank__" <%= (typeof status !== 'undefined' && status === '__blank__') ? 'selected' : '' %>>Blank (empty)</option>
                            <% if (Array.isArray(statusList)) { %>
                                <% statusList.forEach(function(s) { %>
                                    <option value="<%= s %>" <%= (typeof status !== 'undefined' && status === s) ? 'selected' : '' %>><%= s %></option>
                                <% }) %>
                            <% } %>
                        </select>
                    </div>

                    <div class="md:col-span-12 flex justify-end items-end">
                        <button type="submit" class="bg-violet-300 hover:bg-violet-400 text-violet-800 px-4 py-2 rounded-lg font-medium transition-all">Apply filters</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="mb-8">
            <div class="bg-white rounded-2xl shadow-xl border-0 overflow-hidden">
                <div class="bg-gradient-to-r from-sky-200 to-blue-200 px-6 py-4">
                    <h2 class="text-xl font-semibold text-sky-800 mb-0">
                        <i class="fas fa-list mr-2"></i>Search Results
                        <span class="bg-sky-300/50 text-sky-800 px-3 py-1 rounded-full text-sm ml-2"><%= results.length %> found</span>
                    </h2>
                </div>
                <div class="p-6">
                    <% if (results.length > 0) { %>
                    <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span class="text-green-800">
                                    <% if ((query || '').trim().length > 0) { %>
                                        Found <strong><%= results.length %></strong> records for "<strong><%= query %></strong>"
                                        <% if (type !== 'all') { %>
                                            in <strong><%= type === 'name' ? 'Company Name' : type === 'website' ? 'Website' : 'Category' %></strong>
                                        <% } %>
                                    <% } else { %>
                                        Showing all <strong><%= results.length %></strong> records
                                    <% } %>
                                </span>
                            </div>
                            <!-- Toggle de visualização: Cards vs Tabela -->
                            <form method="GET" action="/search" class="flex items-center gap-2">
                                <input type="hidden" name="query" value="<%= query %>" />
                                <input type="hidden" name="type" value="<%= type %>" />
                                <input type="hidden" name="buyer" value="<%= typeof buyer !== 'undefined' ? buyer : '' %>" />
                                <input type="hidden" name="category" value="<%= typeof category !== 'undefined' ? category : '' %>" />
                                <input type="hidden" name="accountStatus" value="<%= typeof accountStatus !== 'undefined' ? accountStatus : '' %>" />
                                <input type="hidden" name="status" value="<%= typeof status !== 'undefined' ? status : '' %>" />
                                <input type="hidden" name="sortBy" value="<%= typeof sortBy !== 'undefined' ? sortBy : '' %>" />
                                <input type="hidden" name="sortDirection" value="<%= typeof sortDirection !== 'undefined' ? sortDirection : 'asc' %>" />
                                <input type="hidden" name="submitted" value="1" />
                                <input type="hidden" name="listAll" value="<%= listAll === '1' ? '1' : '' %>" />
                                <button type="submit" name="view" value="grid" class="px-3 py-1 rounded-lg text-sm font-medium <%= view === 'grid' ? 'bg-sky-500 text-white' : 'bg-sky-100 text-sky-800 hover:bg-sky-200' %>">
                                    <i class="fas fa-th-large mr-1"></i> Cards
                                </button>
                                <button type="submit" name="view" value="table" class="px-3 py-1 rounded-lg text-sm font-medium <%= view === 'table' ? 'bg-sky-500 text-white' : 'bg-sky-100 text-sky-800 hover:bg-sky-200' %>">
                                    <i class="fas fa-table mr-1"></i> Table
                                </button>
                            </form>
                        </div>
                    </div>
                
                    <% if (view === 'table') { %>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Website</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Account Status</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Manager</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <% results.forEach(function(record) { %>
                                        <% const canSeeDetails = (user.role === 'admin' || (user.role === 'gerente' && record._isResponsible)); %>
                                        <tr>
                                            <td class="px-4 py-2 text-sm text-gray-900"><%= record.Name || 'N/A' %></td>
                                            <td class="px-4 py-2 text-sm">
                                                <% if (record.Website) { %>
                                                    <a href="<%= record.Website.startsWith('http') ? record.Website : 'http://' + record.Website %>" target="_blank" class="text-sky-600 hover:text-sky-800 break-all">
                                                        <i class="fas fa-external-link-alt mr-1"></i><%= record.Website %>
                                                    </a>
                                                <% } else { %>
                                                    <span class="text-gray-400">N/A</span>
                                                <% } %>
                                            </td>
                                            <td class="px-4 py-2 text-sm"><%= canSeeDetails ? (record['CATEGORÍA'] || 'N/A') : '—' %></td>
                                            <td class="px-4 py-2 text-sm">
                                                <% if (canSeeDetails) { %>
                                                    <% let accountStatusClass = 'bg-gray-100 text-gray-800';
                                                       let accountStatus = record['Account Request Status'] || 'N/A';
                                                       if (accountStatus.includes('APPROVED')) accountStatusClass = 'bg-green-100 text-green-800';
                                                       else if (accountStatus.includes('NOT APPROVED')) accountStatusClass = 'bg-red-100 text-red-800';
                                                       else if (accountStatus.includes('PENDING')) accountStatusClass = 'bg-yellow-100 text-yellow-800'; %>
                                                    <span class="<%= accountStatusClass %> px-2 py-1 rounded-lg text-xs font-medium"><%= accountStatus %></span>
                                                <% } else { %>
                                                    <span class="text-gray-400">—</span>
                                                <% } %>
                                            </td>
                                            <td class="px-4 py-2 text-sm">
                                                <% if (canSeeDetails) { %>
                                                    <% 
                                                       let statusClass = 'bg-gray-100 text-gray-800';
                                                       let statusRaw = record['STATUS (PENDING APPROVAL, BUYING, CHECKING, NOT COMPETITIVE, NOT INTERESTING, RED FLAG)'] || 'N/A';
                                                       let status = statusRaw;
                                                       // Normalize broken status like "CKING URRRENTLY NOT PRIORITY" to "CHECKING"
                                                       if (/CKING.*NOT PRIORITY/i.test(statusRaw)) {
                                                           status = 'CHECKING';
                                                       }
                                                       if (status.includes('BUYING')) statusClass = 'bg-green-100 text-green-800';
                                                       else if (status.includes('PENDING')) statusClass = 'bg-yellow-100 text-yellow-800';
                                                       else if (status.includes('CHECKING')) statusClass = 'bg-green-100 text-green-800';
                                                       else if (status.includes('NOT')) statusClass = 'bg-red-100 text-red-800';
                                                       else if (status.includes('RED FLAG')) statusClass = 'bg-red-100 text-red-800'; 
                                                    %>
                                                    <span class="<%= statusClass %> px-2 py-1 rounded-lg text-xs font-medium break-words"><%= status %></span>
                                                <% } else { %>
                                                    <span class="text-gray-400">—</span>
                                                <% } %>
                                            </td>
                                            <td class="px-4 py-2 text-sm text-gray-900"><%= record.Responsable || 'N/A' %></td>
                                            <td class="px-4 py-2 text-sm">
                                                <% let prioClass = 'bg-gray-500';
                                                   let prio = record['PRIO (1 - TOP, 5 - bajo)'] || 'N/A';
                                                   if (prio == '1') prioClass = 'bg-red-500';
                                                   else if (prio == '2') prioClass = 'bg-yellow-500';
                                                   else if (prio == '3') prioClass = 'bg-cyan-500';
                                                   else if (prio == '4' || prio == '5') prioClass = 'bg-green-500'; %>
                                                <span class="<%= prioClass %> text-white px-2 py-1 rounded-full text-xs font-medium">P<%= prio %></span>
                                            </td>
                                            <td class="px-4 py-2 text-sm">
                                                <% 
                                                    const isMarceloCA = (
                                                        user.role === 'gerente' &&
                                                        (user.email || '').toLowerCase() === 'marcelogalvis@mylokok.com' &&
                                                        (
                                                            (typeof selectedCountry !== 'undefined' && selectedCountry === 'CA') ||
                                                            (record._countryCode === 'CA')
                                                        )
                                                    );
                                                    const canEditDelete = (user.role === 'admin') || (user.role === 'gerente' && (record._isResponsible || isMarceloCA));
                                                %>
                                                <% if (canEditDelete) { %>
                                                    <div class="flex items-center gap-2">
                                                        <a href="/edit/<%= record._realIndexCountry %>?country=<%= record._countryCode || selectedCountry %>" class="inline-flex items-center px-2 py-1 bg-blue-500 text-white text-xs font-medium rounded hover:bg-blue-600">
                                                            <i class="fas fa-edit mr-1"></i> Edit
                                                        </a>
                                                        <button type="button" data-id="<%= record._realIndexCountry %>" data-country="<%= record._countryCode || selectedCountry %>" class="btn-delete inline-flex items-center px-2 py-1 bg-red-500 text-white text-xs font-medium rounded hover:bg-red-600">
                                                            <i class="fas fa-trash-alt mr-1"></i> Delete
                                                        </button>
                                                    </div>
                                                <% } else { %>
                                                    <span class="text-gray-400">—</span>
                                                <% } %>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    <% } else { %>
                        <div class="results-grid">
                            <% results.forEach(function(record) { %>
                            <div class="bg-white rounded-xl shadow-lg border border-gray-100 hover:shadow-xl transition-all duration-300 hover:-translate-y-1">
                                <div class="bg-gradient-to-r from-sky-200 to-blue-200 px-4 py-3 rounded-t-xl flex justify-between items-center">
                                    <h3 class="text-base font-semibold text-sky-800 truncate" title="<%= record.Name || 'N/A' %>">
                                        <i class="fas fa-building mr-2"></i><%= record.Name || 'N/A' %>
                                    </h3>
                                    <% 
                                    let prioClass = 'bg-gray-500';
                                    let prio = record['PRIO (1 - TOP, 5 - bajo)'] || 'N/A';
                                    if (prio == '1') prioClass = 'bg-red-500';
                                    else if (prio == '2') prioClass = 'bg-yellow-500';
                                    else if (prio == '3') prioClass = 'bg-cyan-500';
                                    else if (prio == '4' || prio == '5') prioClass = 'bg-green-500';
                                    %>
                                    <span class="<%= prioClass %> text-white px-2 py-1 rounded-full text-xs font-medium">P<%= prio %></span>
                                </div>
                                <div class="p-4">
                                    <!-- Website -->
                                    <div class="mb-3">
                                        <div class="text-xs text-gray-500 mb-1"><i class="fas fa-globe mr-1"></i>Website:</div>
                                        <% if (record.Website) { %>
                                            <a href="<%= record.Website.startsWith('http') ? record.Website : 'http://' + record.Website %>" target="_blank" class="text-sky-500 hover:text-sky-700 text-sm break-all">
                                                <i class="fas fa-external-link-alt mr-1"></i><%= record.Website %>
                                            </a>
                                        <% } else { %>
                                            <span class="text-gray-400 text-sm">N/A</span>
                                        <% } %>
                                    </div>
                                    
                                    <% 
                                        const isMarceloCA = (
                                            user.role === 'gerente' &&
                                            (user.email || '').toLowerCase() === 'marcelogalvis@mylokok.com' &&
                                            (
                                                (typeof selectedCountry !== 'undefined' && selectedCountry === 'CA') ||
                                                (record._countryCode === 'CA')
                                            )
                                        );
                                        const canSeeDetails = (user.role === 'admin') || (user.role === 'gerente' && (record._isResponsible || isMarceloCA));
                                    %>
                                    <% if (canSeeDetails) { %>
                                    <!-- Categoria -->
                                    <div class="mb-3">
                                        <div class="text-xs text-gray-500 mb-1"><i class="fas fa-tag mr-1"></i>Category:</div>
                                        <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded-lg text-xs font-medium"><%= record['CATEGORÍA'] || 'N/A' %></span>
                                    </div>
                                    
                                    <!-- Status da Conta -->
                                    <div class="mb-3">
                                        <div class="text-xs text-gray-500 mb-1"><i class="fas fa-user-check mr-1"></i>Account Status:</div>
                                        <% 
                                        let accountStatusClass = 'bg-gray-100 text-gray-800';
                                        let accountStatus = record['Account Request Status'] || 'N/A';
                                        if (accountStatus.includes('APPROVED')) accountStatusClass = 'bg-green-100 text-green-800';
                                        else if (accountStatus.includes('NOT APPROVED')) accountStatusClass = 'bg-red-100 text-red-800';
                                        else if (accountStatus.includes('PENDING')) accountStatusClass = 'bg-yellow-100 text-yellow-800';
                                        %>
                                        <span class="<%= accountStatusClass %> px-2 py-1 rounded-lg text-xs font-medium"><%= accountStatus %></span>
                                    </div>
                                    
                                    <!-- Status Geral -->
                                    <div class="mb-3">
                                        <div class="text-xs text-gray-500 mb-1"><i class="fas fa-flag mr-1"></i>Status:</div>
                                        <% 
                                        let statusClass = 'bg-gray-100 text-gray-800';
                                        let statusRaw = record['STATUS (PENDING APPROVAL, BUYING, CHECKING, NOT COMPETITIVE, NOT INTERESTING, RED FLAG)'] || 'N/A';
                                        let status = statusRaw;
                                        // Normalize broken status like "CKING URRRENTLY NOT PRIORITY" to "CHECKING"
                                        if (/CKING.*NOT PRIORITY/i.test(statusRaw)) {
                                            status = 'CHECKING';
                                        }
                                        if (status.includes('BUYING')) statusClass = 'bg-green-100 text-green-800';
                                        else if (status.includes('PENDING')) statusClass = 'bg-yellow-100 text-yellow-800';
                                        else if (status.includes('CHECKING')) statusClass = 'bg-green-100 text-green-800';
                                        else if (status.includes('NOT')) statusClass = 'bg-red-100 text-red-800';
                                        else if (status.includes('RED FLAG')) statusClass = 'bg-red-100 text-red-800';
                                        %>
                                        <span class="<%= statusClass %> px-2 py-1 rounded-lg text-xs font-medium break-words"><%= status %></span>
                                    </div>
                                    <% } %>
                                    
                                    <!-- Responsável -->
                                    <div class="mb-3">
                                        <div class="text-xs text-gray-500 mb-1"><i class="fas fa-user mr-1"></i>Manager:</div>
                                        <div class="font-semibold text-sm text-gray-900"><%= record.Responsable || 'N/A' %></div>
                                    </div>
                                    
                                    <% if (user.role === 'gerente' && !record._isResponsible && !isMarceloCA) { %>
                                    <!-- Aviso de informações limitadas -->
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-3">
                                        <div class="flex items-center">
                                            <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                                            <span class="text-blue-800 text-xs">
                                                Limited information - You are not the manager of this account
                                            </span>
                                        </div>
                                    </div>
                                    <% } %>
                                    
                                    <% if (canSeeDetails) { %>
                                    <!-- Informações de Contato -->
                                    <div class="border-t border-gray-200 pt-3 mt-3">
                                        <div class="mb-2">
                                            <span class="text-xs text-gray-500"><i class="fas fa-user-tie mr-1"></i>Contact:</span>
                                            <span class="ml-2 text-sm text-gray-900"><%= record['Contact Name'] || 'N/A' %></span>
                                        </div>
                                        <div class="mb-2">
                                            <span class="text-xs text-gray-500"><i class="fas fa-phone mr-1"></i>Phone:</span>
                                            <span class="ml-2 text-sm text-gray-900 font-mono"><%= record['Contact Phone'] || 'N/A' %></span>
                                        </div>
                                        <div class="mb-2">
                                            <span class="text-xs text-gray-500"><i class="fas fa-envelope mr-1"></i>Email:</span>
                                            <span class="ml-2 text-sm text-gray-900 font-mono break-all"><%= record['E-Mail'] || 'N/A' %></span>
                                        </div>
                                    </div>
                                    <% } %>
                                    
                                    <% if (user.role === 'admin') { %>
                                    <div class="border-t border-gray-200 pt-3 mt-3">
                                        <div class="mb-2">
                                            <span class="text-xs text-gray-500"><i class="fas fa-map-marker-alt mr-1"></i>Address:</span>
                                            <span class="ml-2 text-sm text-gray-900 break-words"><%= record.Address || 'N/A' %></span>
                                        </div>
                                        <div class="mb-2">
                                            <span class="text-xs text-gray-500"><i class="fas fa-user-cog mr-1"></i>User:</span>
                                            <span class="ml-2 text-sm text-gray-900 font-mono"><%= record.User || 'N/A' %></span>
                                        </div>
                                    </div>
                                    <% } %>
                                    
                                    <!-- Botões de Ação -->
                                    <% if ((user.role === 'admin') || (user.role === 'gerente' && (record._isResponsible || isMarceloCA))) { %>
                                    <div class="border-t border-gray-200 pt-3 mt-3 flex items-center gap-2">
                                        <a href="/edit/<%= record._realIndexCountry %>?country=<%= record._countryCode || selectedCountry %>" 
                                           class="inline-flex items-center px-3 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white text-sm font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                                            <i class="fas fa-edit mr-2"></i>
                                            Edit
                                        </a>
                                        <button type="button" data-id="<%= record._realIndexCountry %>" data-country="<%= record._countryCode || selectedCountry %>" 
                                            class="btn-delete inline-flex items-center px-3 py-2 bg-gradient-to-r from-red-500 to-red-600 text-white text-sm font-medium rounded-lg hover:from-red-600 hover:to-red-700 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                                            <i class="fas fa-trash-alt mr-2"></i>
                                            Delete
                                        </button>
                                    </div>
                                    <% } %>
                                </div>
                                </div>
                            <% }); %>
                        </div>
                    <% } %>
                    <% } else { %>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                                <span class="text-yellow-800">
                                    <% if ((query || '').trim().length > 0) { %>
                                        No records found for "<strong><%= query %></strong>"
                                        <% if (type !== 'all') { %>
                                            in <strong><%= type === 'name' ? 'Company Name' : type === 'website' ? 'Website' : 'Category' %></strong>
                                        <% } %>
                                    <% } else { %>
                                        No records available
                                    <% } %>
                                </span>
                            </div>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
                            <h3 class="text-base font-semibold text-blue-900 mb-3">
                                <i class="fas fa-lightbulb mr-2"></i>Search tips:
                            </h3>
                            <ul class="text-sm text-blue-800 space-y-1 mb-0">
                                <li>• Try using more general terms</li>
                                <li>• Check spelling</li>
                                <li>• Use "All fields" for a broader search</li>
                                <li>• Try searching for parts of the name or category</li>
                            </ul>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Sort Controls After Results -->
        <div class="bg-white rounded-2xl shadow-xl border-0 overflow-hidden mt-6">
            <div class="bg-gradient-to-r from-sky-200 to-blue-200 px-6 py-4 flex items-center justify-between">
                <h2 class="text-xl font-semibold text-sky-800 mb-0">
                    <i class="fas fa-sort mr-2"></i>Sort
                </h2>
                <form method="GET" action="/search" class="flex items-center gap-3">
                    <input type="hidden" name="query" value="<%= query %>" />
                    <input type="hidden" name="type" value="<%= type %>" />
                    <input type="hidden" name="buyer" value="<%= typeof buyer !== 'undefined' ? buyer : '' %>" />
                    <input type="hidden" name="category" value="<%= typeof category !== 'undefined' ? category : '' %>" />
                    <input type="hidden" name="accountStatus" value="<%= typeof accountStatus !== 'undefined' ? accountStatus : '' %>" />
                    <input type="hidden" name="status" value="<%= typeof status !== 'undefined' ? status : '' %>" />
                    <input type="hidden" name="submitted" value="1" />
                    <input type="hidden" name="listAll" value="<%= listAll === '1' ? '1' : '' %>" />
 
                    <div>
                        <label class="block textxs font-medium text-gray-700 mb-1">Sort By</label>
                        <select name="sortBy" class="w-40 px-3 py-2 border-2 border-gray-200 rounded-lg">
                            <option value="" <%= (typeof sortBy === 'undefined' || !sortBy) ? 'selected' : '' %>>None</option>
                            <option value="status" <%= (typeof sortBy !== 'undefined' && sortBy === 'status') ? 'selected' : '' %>>Status</option>
                            <option value="buyer" <%= (typeof sortBy !== 'undefined' && sortBy === 'buyer') ? 'selected' : '' %>>Buyer</option>
                            <option value="category" <%= (typeof sortBy !== 'undefined' && sortBy === 'category') ? 'selected' : '' %>>Category</option>
                            <option value="accountStatus" <%= (typeof sortBy !== 'undefined' && sortBy === 'accountStatus') ? 'selected' : '' %>>Account Status</option>
                        </select>
                    </div>
                    <div>
                        <label class="block textxs font-medium text-gray-700 mb-1">Direction</label>
                        <select name="sortDirection" class="w-32 px-3 py-2 border-2 border-gray-200 rounded-lg">
                            <option value="asc" <%= (typeof sortDirection === 'undefined' || sortDirection !== 'desc') ? 'selected' : '' %>>Asc</option>
                            <option value="desc" <%= (typeof sortDirection !== 'undefined' && sortDirection === 'desc') ? 'selected' : '' %>>Desc</option>
                        </select>
                    </div>
 
                    <div class="flex items-end">
                        <button type="submit" class="bg-violet-300 hover:bg-violet-400 text-violet-800 px-4 py-2 rounded-lg font-medium transition-all">Apply</button>
                    </div>
                </form>
            </div>
        </div>
        <% } else { %>
        <div class="bg-white rounded-2xl shadow-xl border-0 overflow-hidden">
            <div class="p-12 text-center">
                <i class="fas fa-search text-6xl text-gray-300 mb-6"></i>
                <h2 class="text-xl font-semibold text-gray-600 mb-3">Enter a search term to get started</h2>
                <p class="text-gray-500">Use the form above to search for companies, websites or categories</p>
            </div>
        </div>
        <% } %>
    </div>
    
    <script>
        // Adicionar animações aos cards
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.bg-white.rounded-xl.shadow-lg');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.6s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });

            // Deleção com confirmação
            const deleteButtons = document.querySelectorAll('.btn-delete');
            deleteButtons.forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = btn.getAttribute('data-id');
                    const nameCell = btn.closest('tr')?.querySelector('td:first-child')?.textContent || '';
                    const confirmMsg = nameCell ? `Tem certeza que deseja deletar o registro "${nameCell}"?` : 'Tem certeza que deseja deletar este registro?';
                    if (!confirm(confirmMsg)) return;

                    btn.disabled = true;
                    const originalHtml = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Deleting...';
                    try {
                        const country = btn.getAttribute('data-country') || '';
                        const qs = country ? `?country=${encodeURIComponent(country)}` : '';
                        const response = await fetch(`/records/${id}${qs}`, { method: 'DELETE' });
                        const result = await response.json().catch(() => ({ success: false }));
                        if (response.ok && result.success) {
                            const row = btn.closest('tr');
                            if (row) {
                                row.remove();
                            } else {
                                window.location.reload();
                            }
                        } else {
                            alert(result.message || 'Falha ao deletar o registro.');
                            btn.disabled = false;
                            btn.innerHTML = originalHtml;
                        }
                    } catch (e) {
                        alert('Erro ao comunicar com o servidor.');
                        btn.disabled = false;
                        btn.innerHTML = originalHtml;
                    }
                });
            });
        });
    </script>
</body>
</html>
