<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search - Registration System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&family=Geist+Mono:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Geist', 'system-ui', 'sans-serif'],
                        'mono': ['Geist Mono', 'monospace']
                    },
                    fontSize: {
                        'base': '16px'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-indigo-500 to-purple-600 min-h-screen font-sans text-base">
    <nav class="bg-sky-100/80 backdrop-blur-md border-b border-sky-200/50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="/dashboard" class="flex items-center text-sky-800 text-xl font-bold hover:text-sky-600 transition-colors">
                    <i class="fas fa-search mr-2"></i>Search System
                </a>
                <div class="flex items-center space-x-4">
                    <a href="/dashboard" class="text-sky-800 hover:text-sky-900 px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200">
                        <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                    </a>
                    <a href="/form" class="text-sky-800 hover:text-sky-900 px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200">
                        <i class="fas fa-plus mr-2"></i>Add
                    </a>
                    <% if (user && user.role === 'admin') { %>
                    <a href="/users" class="text-sky-800 hover:text-sky-900 px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200">
                        <i class="fas fa-users mr-2"></i>Users
                    </a>
                    <% } %>
                    <span class="text-sky-700 text-sm">
                        <i class="fas fa-user mr-1"></i>Hello, <%= user.name %>
                        <span class="bg-sky-200 text-sky-800 px-2 py-1 rounded-full text-xs ml-2"><%= user.role.toUpperCase() %></span>
                    </span>
                    <a href="/logout" class="text-sky-700 hover:text-sky-900 text-sm transition-colors">
                        <i class="fas fa-sign-out-alt mr-1"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Search Form -->
        <div class="mb-8">
            <div class="bg-white rounded-2xl shadow-xl border-0 overflow-hidden">
                <div class="bg-gradient-to-r from-sky-200 to-blue-200 px-6 py-4">
                    <h2 class="text-xl font-semibold text-sky-800 mb-0">
                        <i class="fas fa-search mr-2"></i>Search Records
                    </h2>
                </div>
                <div class="p-6">
                    <form method="GET" action="/search">
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                            <div class="md:col-span-8">
                                <label for="query" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-keyboard mr-2"></i>Search term
                                </label>
                                <input type="text" id="query" name="query" 
                                       value="<%= query %>" placeholder="Type what you want to search..." required
                                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-sky-300 focus:ring-0 transition-colors">
                            </div>
                            
                            <div class="md:col-span-2">
                                <label for="type" class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-filter mr-2"></i>Search in
                                </label>
                                <select id="type" name="type" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-sky-300 focus:ring-0 transition-colors">
                                    <option value="all" <%= type === 'all' ? 'selected' : '' %>>All fields</option>
                                    <option value="name" <%= type === 'name' ? 'selected' : '' %>>Company Name</option>
                                    <option value="website" <%= type === 'website' ? 'selected' : '' %>>Website</option>
                                    <option value="categoria" <%= type === 'categoria' ? 'selected' : '' %>>Category</option>
                                </select>
                            </div>
                            
                            <div class="md:col-span-1 flex items-end">
                                <button type="submit" class="w-full bg-sky-300 hover:bg-sky-400 text-sky-800 px-4 py-3 rounded-xl font-medium transition-all duration-300 hover:-translate-y-1 hover:shadow-lg">
                                    <i class="fas fa-search mr-2"></i>Search
                                </button>
                            </div>
                            
                            <div class="md:col-span-1 flex items-end">
                                <a href="/dashboard" class="w-full bg-slate-300 hover:bg-slate-400 text-slate-800 px-4 py-3 rounded-xl font-medium transition-all duration-300 hover:-translate-y-1 hover:shadow-lg text-center">
                                    <i class="fas fa-arrow-left mr-2"></i>Back
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Results -->
        <% if (query) { %>
        
        <!-- Debug Counts Panel removido: agora disponÃ­vel na aba LOGs -->
        
        <!-- Advanced Filters -->
        <div class="bg-white rounded-2xl shadow-xl border-0 overflow-hidden mb-6">
            <div class="bg-gradient-to-r from-sky-200 to-blue-200 px-6 py-4">
                <h2 class="text-xl font-semibold text-sky-800 mb-0">
                    <i class="fas fa-filter mr-2"></i>Advanced Filters
                </h2>
            </div>
            <div class="p-6">
                <form method="GET" action="/search" class="grid grid-cols-1 md:grid-cols-12 gap-4">
                    <input type="hidden" name="query" value="<%= query %>" />
                    <input type="hidden" name="type" value="<%= type %>" />

                    <div class="md:col-span-3">
                        <label for="buyer" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user-tie mr-2"></i>Manager/Buyer
                        </label>
                        <select id="buyer" name="buyer" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-sky-300 focus:ring-0 transition-colors">
                            <option value="">Any</option>
                            <% if (Array.isArray(managersList)) { %>
                                <% managersList.forEach(function(m) { %>
                                    <option value="<%= m %>" <%= (typeof buyer !== 'undefined' && buyer === m) ? 'selected' : '' %>><%= m %></option>
                                <% }) %>
                            <% } %>
                        </select>
                    </div>

                    <div class="md:col-span-3">
                        <label for="accountStatus" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user-check mr-2"></i>Account Status
                        </label>
                        <select id="accountStatus" name="accountStatus" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-sky-300 focus:ring-0 transition-colors">
                            <option value="">Any</option>
                            <% if (Array.isArray(accountStatusList)) { %>
                                <% accountStatusList.forEach(function(s) { %>
                                    <option value="<%= s %>" <%= (typeof accountStatus !== 'undefined' && accountStatus === s) ? 'selected' : '' %>><%= s %></option>
                                <% }) %>
                            <% } %>
                        </select>
                    </div>

                    <div class="md:col-span-3">
                        <label for="category" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-tag mr-2"></i>Category
                        </label>
                        <input type="text" id="category" name="category" value="<%= typeof category !== 'undefined' ? category : '' %>"
                               placeholder="Type a category" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-sky-300 focus:ring-0 transition-colors">
                    </div>


                    <div class="md:col-span-3">
                        <label for="status" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-flag mr-2"></i>Status
                        </label>
                        <select id="status" name="status" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-sky-300 focus:ring-0 transition-colors">
                            <option value="" <%= (typeof status === 'undefined' || status === '') ? 'selected' : '' %>>Any</option>
                            <option value="PENDING APPROVAL" <%= (typeof status !== 'undefined' && status === 'PENDING APPROVAL') ? 'selected' : '' %>>PENDING APPROVAL</option>
                            <option value="BUYING" <%= (typeof status !== 'undefined' && status === 'BUYING') ? 'selected' : '' %>>BUYING</option>
                            <option value="CHECKING" <%= (typeof status !== 'undefined' && status === 'CHECKING') ? 'selected' : '' %>>CHECKING</option>
                            <option value="NOT COMPETITIVE" <%= (typeof status !== 'undefined' && status === 'NOT COMPETITIVE') ? 'selected' : '' %>>NOT COMPETITIVE</option>
                            <option value="NOT INTERESTING" <%= (typeof status !== 'undefined' && status === 'NOT INTERESTING') ? 'selected' : '' %>>NOT INTERESTING</option>
                            <option value="RED FLAG" <%= (typeof status !== 'undefined' && status === 'RED FLAG') ? 'selected' : '' %>>RED FLAG</option>
                        </select>
                    </div>

                    <div class="md:col-span-12 flex justify-end items-end">
                        <button type="submit" class="bg-violet-300 hover:bg-violet-400 text-violet-800 px-4 py-2 rounded-lg font-medium transition-all">Apply filters</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="mb-8">
            <div class="bg-white rounded-2xl shadow-xl border-0 overflow-hidden">
                <div class="bg-gradient-to-r from-sky-200 to-blue-200 px-6 py-4">
                    <h2 class="text-xl font-semibold text-sky-800 mb-0">
                        <i class="fas fa-list mr-2"></i>Search Results
                        <span class="bg-sky-300/50 text-sky-800 px-3 py-1 rounded-full text-sm ml-2"><%= results.length %> found</span>
                    </h2>
                </div>
                <div class="p-6">
                    <% if (results.length > 0) { %>
                    <div class="bg-green-50 border border-green-200 rounded-xl p-4 mb-6">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            <span class="text-green-800">
                                Found <strong><%= results.length %></strong> records for "<strong><%= query %></strong>"
                                <% if (type !== 'all') { %>
                                    in <strong><%= type === 'name' ? 'Company Name' : type === 'website' ? 'Website' : 'Category' %></strong>
                                <% } %>
                            </span>
                        </div>
                    </div>
                    
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <% results.forEach(function(record) { %>
                                <div class="bg-white rounded-xl shadow-lg border border-gray-100 hover:shadow-xl transition-all duration-300 hover:-translate-y-1">
                                    <div class="bg-gradient-to-r from-sky-200 to-blue-200 px-4 py-3 rounded-t-xl flex justify-between items-center">
                                        <h3 class="text-base font-semibold text-sky-800 truncate" title="<%= record.Name || 'N/A' %>">
                                            <i class="fas fa-building mr-2"></i><%= record.Name || 'N/A' %>
                                        </h3>
                                        <% 
                                        let prioClass = 'bg-gray-500';
                                        let prio = record['PRIO (1 - TOP, 5 - bajo)'] || 'N/A';
                                        if (prio == '1') prioClass = 'bg-red-500';
                                        else if (prio == '2') prioClass = 'bg-yellow-500';
                                        else if (prio == '3') prioClass = 'bg-cyan-500';
                                        else if (prio == '4' || prio == '5') prioClass = 'bg-green-500';
                                        %>
                                        <span class="<%= prioClass %> text-white px-2 py-1 rounded-full text-xs font-medium">P<%= prio %></span>
                                    </div>
                                    <div class="p-4">
                                        <!-- Website -->
                                        <div class="mb-3">
                                            <div class="text-xs text-gray-500 mb-1"><i class="fas fa-globe mr-1"></i>Website:</div>
                                            <% if (record.Website) { %>
                                                <a href="<%= record.Website.startsWith('http') ? record.Website : 'http://' + record.Website %>" target="_blank" class="text-sky-500 hover:text-sky-700 text-sm break-all">
                                                    <i class="fas fa-external-link-alt mr-1"></i><%= record.Website %>
                                                </a>
                                            <% } else { %>
                                                <span class="text-gray-400 text-sm">N/A</span>
                                            <% } %>
                                        </div>
                                        
                                        <% if (user.role === 'admin' || (user.role === 'gerente' && record._isResponsible)) { %>
                                        <!-- Categoria -->
                                        <div class="mb-3">
                                            <div class="text-xs text-gray-500 mb-1"><i class="fas fa-tag mr-1"></i>Category:</div>
                                            <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded-lg text-xs font-medium"><%= record['CATEGORÃA'] || 'N/A' %></span>
                                        </div>
                                        
                                        <!-- Status da Conta -->
                                        <div class="mb-3">
                                            <div class="text-xs text-gray-500 mb-1"><i class="fas fa-user-check mr-1"></i>Account Status:</div>
                                            <% 
                                            let accountStatusClass = 'bg-gray-100 text-gray-800';
                                            let accountStatus = record['Account Request Status'] || 'N/A';
                                            if (accountStatus.includes('APPROVED')) accountStatusClass = 'bg-green-100 text-green-800';
                                            else if (accountStatus.includes('NOT APPROVED')) accountStatusClass = 'bg-red-100 text-red-800';
                                            else if (accountStatus.includes('PENDING')) accountStatusClass = 'bg-yellow-100 text-yellow-800';
                                            %>
                                            <span class="<%= accountStatusClass %> px-2 py-1 rounded-lg text-xs font-medium"><%= accountStatus %></span>
                                        </div>
                                        
                                        <!-- Status Geral -->
                                        <div class="mb-3">
                                            <div class="text-xs text-gray-500 mb-1"><i class="fas fa-flag mr-1"></i>Status:</div>
                                            <% 
                                            let statusClass = 'bg-gray-100 text-gray-800';
                                            let status = record['STATUS (PENDING APPROVAL, BUYING, CHECKING, NOT COMPETITIVE, NOT INTERESTING, RED FLAG)'] || 'N/A';
                                            if (status.includes('BUYING')) statusClass = 'bg-green-100 text-green-800';
                                            else if (status.includes('PENDING')) statusClass = 'bg-yellow-100 text-yellow-800';
                                            else if (status.includes('CHECKING')) statusClass = 'bg-cyan-100 text-cyan-800';
                                            else if (status.includes('NOT')) statusClass = 'bg-red-100 text-red-800';
                                            else if (status.includes('RED FLAG')) statusClass = 'bg-red-100 text-red-800';
                                            %>
                                            <span class="<%= statusClass %> px-2 py-1 rounded-lg text-xs font-medium break-words"><%= status %></span>
                                        </div>
                                        <% } %>
                                        
                                        <!-- ResponsÃ¡vel -->
                                        <div class="mb-3">
                                            <div class="text-xs text-gray-500 mb-1"><i class="fas fa-user mr-1"></i>Manager:</div>
                                            <div class="font-semibold text-sm text-gray-900"><%= record.Responsable || 'N/A' %></div>
                                        </div>
                                        
                                        <% if (user.role === 'gerente' && !record._isResponsible) { %>
                                        <!-- Aviso de informaÃ§Ãµes limitadas -->
                                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-3">
                                            <div class="flex items-center">
                                                <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                                                <span class="text-blue-800 text-xs">
                                                    Limited information - You are not the manager of this account
                                                </span>
                                            </div>
                                        </div>
                                        <% } %>
                                        
                                        <% if (user.role === 'admin' || (user.role === 'gerente' && record._isResponsible)) { %>
                                        <!-- InformaÃ§Ãµes de Contato -->
                                        <div class="border-t border-gray-200 pt-3 mt-3">
                                            <div class="mb-2">
                                                <span class="text-xs text-gray-500"><i class="fas fa-user-tie mr-1"></i>Contact:</span>
                                                <span class="ml-2 text-sm text-gray-900"><%= record['Contact Name'] || 'N/A' %></span>
                                            </div>
                                            <div class="mb-2">
                                                <span class="text-xs text-gray-500"><i class="fas fa-phone mr-1"></i>Phone:</span>
                                                <span class="ml-2 text-sm text-gray-900 font-mono"><%= record['Contact Phone'] || 'N/A' %></span>
                                            </div>
                                            <div class="mb-2">
                                                <span class="text-xs text-gray-500"><i class="fas fa-envelope mr-1"></i>Email:</span>
                                                <span class="ml-2 text-sm text-gray-900 font-mono break-all"><%= record['E-Mail'] || 'N/A' %></span>
                                            </div>
                                        </div>
                                        <% } %>
                                        
                                        <% if (user.role === 'admin') { %>
                                        <div class="border-t border-gray-200 pt-3 mt-3">
                                            <div class="mb-2">
                                                <span class="text-xs text-gray-500"><i class="fas fa-map-marker-alt mr-1"></i>Address:</span>
                                                <span class="ml-2 text-sm text-gray-900 break-words"><%= record.Address || 'N/A' %></span>
                                            </div>
                                            <div class="mb-2">
                                                <span class="text-xs text-gray-500"><i class="fas fa-user-cog mr-1"></i>User:</span>
                                                <span class="ml-2 text-sm text-gray-900 font-mono"><%= record.User || 'N/A' %></span>
                                            </div>
                                        </div>
                                        <% } %>
                                        
                                        <!-- BotÃ£o de Editar -->
                                        <% if (user.role === 'admin' || (user.role === 'gerente' && record._isResponsible)) { %>
                                        <div class="border-t border-gray-200 pt-3 mt-3">
                                            <a href="/edit/<%= record._realIndex %>" 
                                               class="inline-flex items-center px-3 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white text-sm font-medium rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                                                <i class="fas fa-edit mr-2"></i>
                                                Edit
                                            </a>
                                        </div>
                                        <% } %>
                                    </div>
                                </div>
                                <% }); %>
                            </div>
                     <% } else { %>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-6">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                            <span class="text-yellow-800">
                                No records found for "<strong><%= query %></strong>"
                                <% if (type !== 'all') { %>
                                    in <strong><%= type === 'name' ? 'Company Name' : type === 'website' ? 'Website' : 'Category' %></strong>
                                <% } %>
                            </span>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
                        <h3 class="text-base font-semibold text-blue-900 mb-3">
                            <i class="fas fa-lightbulb mr-2"></i>Search tips:
                        </h3>
                        <ul class="text-sm text-blue-800 space-y-1 mb-0">
                            <li>â¢ Try using more general terms</li>
                            <li>â¢ Check spelling</li>
                            <li>â¢ Use "All fields" for a broader search</li>
                            <li>â¢ Try searching for parts of the name or category</li>
                        </ul>
                    </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Sort Controls After Results -->
        <div class="bg-white rounded-2xl shadow-xl border-0 overflow-hidden mt-6">
            <div class="bg-gradient-to-r from-sky-200 to-blue-200 px-6 py-4 flex items-center justify-between">
                <h2 class="text-xl font-semibold text-sky-800 mb-0">
                    <i class="fas fa-sort mr-2"></i>Sort
                </h2>
                <form method="GET" action="/search" class="flex items-center gap-3">
                    <input type="hidden" name="query" value="<%= query %>" />
                    <input type="hidden" name="type" value="<%= type %>" />
                    <input type="hidden" name="buyer" value="<%= typeof buyer !== 'undefined' ? buyer : '' %>" />
                    <input type="hidden" name="category" value="<%= typeof category !== 'undefined' ? category : '' %>" />
                    <input type="hidden" name="accountStatus" value="<%= typeof accountStatus !== 'undefined' ? accountStatus : '' %>" />
                    <input type="hidden" name="status" value="<%= typeof status !== 'undefined' ? status : '' %>" />

                    <div>
                        <label class="block textxs font-medium text-gray-700 mb-1">Sort By</label>
                        <select name="sortBy" class="w-40 px-3 py-2 border-2 border-gray-200 rounded-lg">
                            <option value="" <%= (typeof sortBy === 'undefined' || !sortBy) ? 'selected' : '' %>>None</option>
                            <option value="status" <%= (typeof sortBy !== 'undefined' && sortBy === 'status') ? 'selected' : '' %>>Status</option>
                            <option value="buyer" <%= (typeof sortBy !== 'undefined' && sortBy === 'buyer') ? 'selected' : '' %>>Buyer</option>
                            <option value="category" <%= (typeof sortBy !== 'undefined' && sortBy === 'category') ? 'selected' : '' %>>Category</option>
                            <option value="accountStatus" <%= (typeof sortBy !== 'undefined' && sortBy === 'accountStatus') ? 'selected' : '' %>>Account Status</option>
                        </select>
                    </div>
                    <div>
                        <label class="block textxs font-medium text-gray-700 mb-1">Direction</label>
                        <select name="sortDirection" class="w-32 px-3 py-2 border-2 border-gray-200 rounded-lg">
                            <option value="asc" <%= (typeof sortDirection === 'undefined' || sortDirection !== 'desc') ? 'selected' : '' %>>Asc</option>
                            <option value="desc" <%= (typeof sortDirection !== 'undefined' && sortDirection === 'desc') ? 'selected' : '' %>>Desc</option>
                        </select>
                    </div>

                    <div class="flex items-end">
                        <button type="submit" class="bg-violet-300 hover:bg-violet-400 text-violet-800 px-4 py-2 rounded-lg font-medium transition-all">Apply</button>
                    </div>
                </form>
            </div>
        </div>
        <% } else { %>
        <div class="bg-white rounded-2xl shadow-xl border-0 overflow-hidden">
            <div class="p-12 text-center">
                <i class="fas fa-search text-6xl text-gray-300 mb-6"></i>
                <h2 class="text-xl font-semibold text-gray-600 mb-3">Enter a search term to get started</h2>
                <p class="text-gray-500">Use the form above to search for companies, websites or categories</p>
            </div>
        </div>
        <% } %>
    </div>
    
    <script>
        // Adicionar animaÃ§Ãµes aos cards
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.bg-white.rounded-xl.shadow-lg');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    card.style.transition = 'all 0.6s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
        });
    </script>
</body>
</html>